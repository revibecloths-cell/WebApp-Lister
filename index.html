<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Airtable Publisher â€” INVENTARIO</title>
  <style>
    /* â”€â”€â”€ Custom Properties â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --bg:            #0f0f0f;
      --surface:       #1a1a1a;
      --surface2:      #212121;
      --border:        #2a2a2a;
      --accent:        #6366f1;
      --accent-hover:  #4f46e5;
      --text:          #e2e2e2;
      --text-muted:    #888;
      --success:       #22c55e;
      --error:         #ef4444;
      --warning:       #f59e0b;
      --vinted:        #009688;
      --vestiaire:     #c9a96e;
      --shopify:       #96bf48;
    }

    /* â”€â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 14px; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    button { cursor: pointer; border: none; font-family: inherit; font-size: inherit; }
    input, select { font-family: inherit; font-size: inherit; }

    /* â”€â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--surface); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      height: 52px;
      position: sticky;
      top: 0;
      z-index: 100;
      flex-shrink: 0;
    }
    #header h1 {
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text);
      white-space: nowrap;
    }
    #header h1 span { color: var(--accent); }
    #status-badge {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 20px;
      background: var(--surface2);
      color: var(--text-muted);
      border: 1px solid var(--border);
      transition: all 0.3s;
    }
    #status-badge.success { background: rgba(34,197,94,.15); color: var(--success); border-color: rgba(34,197,94,.3); }
    #status-badge.error   { background: rgba(239,68,68,.15);  color: var(--error);   border-color: rgba(239,68,68,.3); }
    #status-badge.loading { background: rgba(99,102,241,.15); color: var(--accent);  border-color: rgba(99,102,241,.3); }
    #header-right { margin-left: auto; display: flex; align-items: center; gap: 8px; }
    #btn-settings {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 0.8rem;
      transition: all 0.2s;
    }
    #btn-settings:hover { border-color: var(--accent); color: var(--text); }
    #btn-refresh {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 0.8rem;
      transition: all 0.2s;
    }
    #btn-refresh:hover { border-color: var(--accent); color: var(--text); }

    /* â”€â”€â”€ Stats Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #stats-bar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 8px 20px;
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
      flex-shrink: 0;
    }
    .stat-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .stat-label {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding: 2px 8px;
      border-radius: 4px;
    }
    .stat-label.vinted   { background: rgba(0,150,136,.2);   color: var(--vinted); }
    .stat-label.vestiaire{ background: rgba(201,169,110,.2);  color: var(--vestiaire); }
    .stat-label.shopify  { background: rgba(150,191,72,.2);   color: var(--shopify); }
    .stat-item { font-size: 0.8rem; color: var(--text-muted); }
    .stat-item strong { color: var(--text); font-weight: 600; }
    .stat-sep { color: var(--border); }

    /* â”€â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px 20px 80px;
      gap: 12px;
    }

    /* â”€â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    #search-input {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 7px 12px;
      border-radius: 6px;
      width: 220px;
      transition: border-color 0.2s;
      outline: none;
    }
    #search-input:focus { border-color: var(--accent); }
    #search-input::placeholder { color: var(--text-muted); }
    #status-filter {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 7px 12px;
      border-radius: 6px;
      outline: none;
      cursor: pointer;
    }
    #status-filter option { background: var(--surface); }
    .platform-filters { display: flex; gap: 6px; }
    .btn-platform {
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      border: 1px solid transparent;
      transition: all 0.2s;
      opacity: 0.45;
    }
    .btn-platform.vinted   { border-color: var(--vinted);   color: var(--vinted);   background: rgba(0,150,136,.08); }
    .btn-platform.vestiaire{ border-color: var(--vestiaire); color: var(--vestiaire); background: rgba(201,169,110,.08); }
    .btn-platform.shopify  { border-color: var(--shopify);  color: var(--shopify);  background: rgba(150,191,72,.08); }
    .btn-platform.active   { opacity: 1; }
    .btn-platform.active.vinted   { background: rgba(0,150,136,.25); }
    .btn-platform.active.vestiaire{ background: rgba(201,169,110,.25); }
    .btn-platform.active.shopify  { background: rgba(150,191,72,.25); }
    #record-count {
      margin-left: auto;
      font-size: 0.8rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    /* â”€â”€â”€ Table Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #table-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      flex: 1;
    }
    #table-wrapper {
      overflow-x: auto;
      overflow-y: auto;
      max-height: calc(100vh - 230px);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
    }
    thead th {
      background: var(--surface2);
      padding: 10px 12px;
      text-align: left;
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      white-space: nowrap;
    }
    thead th.th-vinted    { color: var(--vinted); }
    thead th.th-vestiaire { color: var(--vestiaire); }
    thead th.th-shopify   { color: var(--shopify); }
    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }
    tbody tr:hover { background: rgba(255,255,255,.03); }
    tbody tr:last-child { border-bottom: none; }
    tbody td {
      padding: 9px 12px;
      font-size: 0.85rem;
      vertical-align: middle;
      white-space: nowrap;
    }
    td.td-sku {
      font-weight: 600;
      color: var(--accent);
      cursor: pointer;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    td.td-sku:hover { text-decoration: underline; }
    td.td-brand { color: var(--text); font-weight: 500; }
    td.td-price { color: var(--success); font-weight: 600; }
    td.td-stato span {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.72rem;
      font-weight: 600;
    }
    td.td-stato .badge-disp { background: rgba(34,197,94,.15); color: var(--success); }
    td.td-stato .badge-vend { background: rgba(239,68,68,.15);  color: var(--error); }
    td.td-stato .badge-other{ background: rgba(136,136,136,.15); color: var(--text-muted); }
    td.td-foto a {
      font-size: 1.1rem;
      text-decoration: none;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    td.td-foto a:hover { opacity: 1; }
    /* Platform checkboxes */
    .platform-checkbox-cell { text-align: center; position: relative; }
    .platform-cb {
      appearance: none;
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 2px solid var(--border);
      background: transparent;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
      vertical-align: middle;
    }
    .platform-cb:checked { border-color: transparent; }
    .platform-cb[data-platform="Vinted"]:checked    { background: var(--vinted); border-color: var(--vinted); }
    .platform-cb[data-platform="Vestiaire"]:checked { background: var(--vestiaire); border-color: var(--vestiaire); }
    .platform-cb[data-platform="Shopify"]:checked   { background: var(--shopify); border-color: var(--shopify); }
    .platform-cb:checked::after {
      content: '';
      position: absolute;
      left: 3px; top: 0px;
      width: 8px; height: 13px;
      border: 2px solid #fff;
      border-top: none;
      border-left: none;
      transform: rotate(45deg);
    }
    .platform-cb:disabled { opacity: 0.5; cursor: not-allowed; }
    .cb-spinner {
      display: none;
      width: 14px; height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    .platform-checkbox-cell.loading .platform-cb { opacity: 0; }
    .platform-checkbox-cell.loading .cb-spinner { display: block; }
    /* Dettagli button */
    .btn-detail {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      transition: all 0.2s;
    }
    .btn-detail:hover { border-color: var(--accent); color: var(--accent); }

    /* â”€â”€â”€ Empty State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #empty-state {
      display: none;
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    #empty-state p { margin-top: 8px; font-size: 0.85rem; }

    /* â”€â”€â”€ Loading Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #loading-overlay {
      display: none;
      position: absolute;
      inset: 0;
      background: rgba(15,15,15,.8);
      align-items: center;
      justify-content: center;
      z-index: 50;
      border-radius: 8px;
    }
    #loading-overlay.visible { display: flex; }
    .spinner-large {
      width: 36px; height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* â”€â”€â”€ Setup Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #setup-screen {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.85);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }
    #setup-screen.visible { display: flex; }
    .setup-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 32px;
      width: 420px;
      max-width: 95vw;
    }
    .setup-card h2 {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .setup-card p {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-bottom: 24px;
    }
    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block;
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 6px;
    }
    .form-group input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 6px;
      transition: border-color 0.2s;
      outline: none;
    }
    .form-group input:focus { border-color: var(--accent); }
    .form-group input::placeholder { color: var(--text-muted); }
    #btn-save-setup {
      width: 100%;
      background: var(--accent);
      color: #fff;
      padding: 10px;
      border-radius: 6px;
      font-weight: 600;
      transition: background 0.2s;
      margin-top: 8px;
    }
    #btn-save-setup:hover { background: var(--accent-hover); }
    #setup-error {
      margin-top: 12px;
      font-size: 0.8rem;
      color: var(--error);
      display: none;
    }

    /* â”€â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.75);
      z-index: 300;
      align-items: flex-start;
      justify-content: center;
      padding: 40px 16px;
      overflow-y: auto;
    }
    #modal-backdrop.visible { display: flex; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 560px;
      max-width: 100%;
      position: relative;
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--border);
    }
    .modal-header h3 { font-size: 1rem; font-weight: 700; }
    .modal-header .modal-sku {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .btn-close-modal {
      background: transparent;
      color: var(--text-muted);
      font-size: 1.4rem;
      line-height: 1;
      padding: 0 4px;
      transition: color 0.2s;
    }
    .btn-close-modal:hover { color: var(--text); }
    .modal-body { padding: 20px 24px; }
    .modal-photo {
      width: 100%;
      max-height: 200px;
      object-fit: contain;
      border-radius: 6px;
      background: var(--bg);
      margin-bottom: 16px;
    }
    .modal-photo-link {
      display: block;
      text-align: center;
      padding: 12px;
      background: var(--bg);
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 0.85rem;
    }
    .modal-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal-field label {
      display: block;
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 3px;
    }
    .modal-field .value {
      font-size: 0.88rem;
      color: var(--text);
      word-break: break-word;
    }
    .modal-field.full { grid-column: 1 / -1; }
    .modal-field .value.long {
      background: var(--bg);
      padding: 8px 10px;
      border-radius: 6px;
      white-space: pre-wrap;
      font-size: 0.82rem;
      line-height: 1.5;
      max-height: 120px;
      overflow-y: auto;
    }
    .copy-row { display: flex; align-items: flex-start; gap: 8px; }
    .copy-row .value { flex: 1; }
    .btn-copy {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.72rem;
      white-space: nowrap;
      transition: all 0.2s;
      flex-shrink: 0;
      margin-top: 0;
    }
    .btn-copy:hover { border-color: var(--accent); color: var(--accent); }
    .btn-copy.copied { color: var(--success); border-color: var(--success); }
    .modal-platforms {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .platform-pill {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid transparent;
    }
    .platform-pill.vinted    { border-color: var(--vinted);    color: var(--vinted);    background: rgba(0,150,136,.1); }
    .platform-pill.vestiaire { border-color: var(--vestiaire);  color: var(--vestiaire); background: rgba(201,169,110,.1); }
    .platform-pill.shopify   { border-color: var(--shopify);   color: var(--shopify);   background: rgba(150,191,72,.1); }
    .platform-pill.inactive  { opacity: 0.4; }

    /* â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.82rem;
      opacity: 0;
      transition: all 0.3s;
      pointer-events: none;
      z-index: 400;
      white-space: nowrap;
    }
    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    #toast.error  { border-color: var(--error);   color: var(--error); }
    #toast.success{ border-color: var(--success);  color: var(--success); }

    /* â”€â”€â”€ Debug Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #debug-toggle {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.78rem;
      z-index: 500;
      transition: all 0.2s;
    }
    #debug-toggle:hover { border-color: var(--accent); color: var(--accent); }
    #debug-panel {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 220px;
      background: #0a0a0a;
      border-top: 1px solid var(--border);
      z-index: 490;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    #debug-panel.open { transform: translateY(0); }
    #debug-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 12px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    #debug-panel-header span {
      font-size: 0.72rem;
      color: var(--text-muted);
      font-family: monospace;
    }
    #btn-clear-debug {
      background: transparent;
      color: var(--text-muted);
      font-size: 0.72rem;
      border: 1px solid var(--border);
      padding: 2px 8px;
      border-radius: 4px;
    }
    #btn-clear-debug:hover { color: var(--error); border-color: var(--error); }
    #debug-log {
      flex: 1;
      overflow-y: auto;
      padding: 8px 12px;
      font-family: "SF Mono", "Fira Code", monospace;
      font-size: 0.72rem;
      line-height: 1.6;
    }
    .log-success { color: var(--success); }
    .log-error   { color: var(--error); }
    .log-pending { color: var(--warning); }
    .log-info    { color: #888; }

    /* â”€â”€â”€ Spinner Animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @keyframes spin-abs {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .platform-checkbox-cell .cb-spinner {
      animation: spin-abs 0.6s linear infinite;
    }

    /* â”€â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 768px) {
      #toolbar { flex-direction: column; align-items: stretch; }
      #search-input { width: 100%; }
      #record-count { margin-left: 0; }
      .platform-filters { justify-content: center; }
      #stats-bar { gap: 12px; }
      .stat-group { flex-wrap: wrap; }
      .setup-card { padding: 24px 16px; }
      .modal-fields { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header id="header">
    <h1>Airtable <span>Publisher</span></h1>
    <span id="status-badge">â€”</span>
    <div id="header-right">
      <button id="btn-refresh" title="Ricarica records">â†» Refresh</button>
      <button id="btn-settings" title="Impostazioni">âš™ Config</button>
    </div>
  </header>

  <!-- â”€â”€â”€ Stats Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="stats-bar">
    <div class="stat-group">
      <span class="stat-label vinted">Vinted</span>
      <span class="stat-item">Pubblicati: <strong id="stat-vinted-pub">â€”</strong></span>
      <span class="stat-sep">Â·</span>
      <span class="stat-item">Da caricare: <strong id="stat-vinted-todo">â€”</strong></span>
    </div>
    <div class="stat-group">
      <span class="stat-label vestiaire">Vestiaire</span>
      <span class="stat-item">Pubblicati: <strong id="stat-vestiaire-pub">â€”</strong></span>
      <span class="stat-sep">Â·</span>
      <span class="stat-item">Da caricare: <strong id="stat-vestiaire-todo">â€”</strong></span>
    </div>
    <div class="stat-group">
      <span class="stat-label shopify">Shopify</span>
      <span class="stat-item">Pubblicati: <strong id="stat-shopify-pub">â€”</strong></span>
      <span class="stat-sep">Â·</span>
      <span class="stat-item">Da caricare: <strong id="stat-shopify-todo">â€”</strong></span>
    </div>
  </div>

  <!-- â”€â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <main id="main">

    <!-- Toolbar -->
    <div id="toolbar">
      <input id="search-input" type="search" placeholder="Cerca SKU, brand, categoriaâ€¦" autocomplete="off" />
      <select id="status-filter">
        <option value="">Tutti gli stati</option>
        <option value="Disponibile">Disponibile</option>
        <option value="Venduto">Venduto</option>
      </select>
      <div class="platform-filters">
        <button class="btn-platform vinted"    data-platform="Vinted">Vinted</button>
        <button class="btn-platform vestiaire" data-platform="Vestiaire">Vestiaire</button>
        <button class="btn-platform shopify"   data-platform="Shopify">Shopify</button>
      </div>
      <span id="record-count"></span>
    </div>

    <!-- Table Card -->
    <div id="table-card" style="position:relative;">
      <div id="loading-overlay"><div class="spinner-large"></div></div>
      <div id="table-wrapper">
        <table id="records-table">
          <thead>
            <tr>
              <th>SKU</th>
              <th>Foto</th>
              <th>Brand</th>
              <th>Taglia</th>
              <th>Prezzo</th>
              <th>Stato</th>
              <th class="th-vinted">Vinted</th>
              <th class="th-vestiaire">Vestiaire</th>
              <th class="th-shopify">Shopify</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="records-tbody"></tbody>
        </table>
        <div id="empty-state">
          <div style="font-size:2rem;">ğŸ“¦</div>
          <p>Nessun record trovato.</p>
        </div>
      </div>
    </div>

  </main>

  <!-- â”€â”€â”€ Setup Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="setup-screen">
    <div class="setup-card">
      <h2>âš™ Configurazione</h2>
      <p>Inserisci le credenziali Airtable. Vengono salvate nel browser (localStorage).</p>
      <div class="form-group">
        <label>Airtable Token</label>
        <input id="input-token" type="password" placeholder="patXXXXXX.XXXXXXXX" />
      </div>
      <div class="form-group">
        <label>Base ID</label>
        <input id="input-base-id" type="text" placeholder="appXXXXXXXXXXXXXX" />
      </div>
      <div class="form-group">
        <label>Table Name</label>
        <input id="input-table" type="text" placeholder="INVENTARIO" />
      </div>
      <button id="btn-save-setup">Save &amp; Connect</button>
      <div id="setup-error"></div>
    </div>
  </div>

  <!-- â”€â”€â”€ Detail Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="modal-backdrop">
    <div class="modal" id="modal">
      <div class="modal-header">
        <div>
          <h3 id="modal-title">Dettaglio</h3>
          <div class="modal-sku" id="modal-sku-sub"></div>
        </div>
        <button class="btn-close-modal" id="btn-close-modal">Ã—</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <!-- â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="toast"></div>

  <!-- â”€â”€â”€ Debug Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <button id="debug-toggle">ğŸ› Debug</button>
  <div id="debug-panel">
    <div id="debug-panel-header">
      <span>DEBUG LOG</span>
      <button id="btn-clear-debug">ğŸ—‘ Clear</button>
    </div>
    <div id="debug-log"></div>
  </div>

  <script>
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CONFIG  â€” edit this block to change credentials / fields
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const CONFIG = {
    token:  'patkpQw8xAugxzSEF.b35606ff391e860e8f7a979a634a96bf4c2a0f3ff41911ebea8334ee4eb2f0c0',
    baseId: 'appHQYzjPD56acfMq',
    table:  'INVENTARIO',
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STATE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const State = {
    records: [],          // all fetched records
    filtered: [],         // after applying filters
    searchQuery: '',
    statusFilter: '',     // '' | 'Disponibile' | 'Venduto'
    platformFilters: [],  // active platforms (show items NOT on them)
    credentials: null,    // { token, baseId, table }
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STORAGE  â€” localStorage wrappers
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const Storage = {
    KEYS: { creds: 'at_publisher_creds' },
    loadCredentials() {
      try {
        const raw = localStorage.getItem(this.KEYS.creds);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    },
    saveCredentials(creds) {
      localStorage.setItem(this.KEYS.creds, JSON.stringify(creds));
    },
    clearCredentials() {
      localStorage.removeItem(this.KEYS.creds);
    },
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DEBUG
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const Debug = {
    log(method, endpoint, status, detail = '') {
      const el = document.getElementById('debug-log');
      const now = new Date();
      const ts = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
      let cls = 'log-info';
      if (status === 'pending') cls = 'log-pending';
      else if (typeof status === 'number' && status >= 200 && status < 300) cls = 'log-success';
      else if (typeof status === 'number' && status >= 400) cls = 'log-error';
      else if (status === 'ERROR') cls = 'log-error';
      const preview = detail ? ` | ${String(detail).slice(0, 60)}` : '';
      const line = document.createElement('div');
      line.className = cls;
      line.textContent = `[${ts}] ${method.padEnd(6)} ${endpoint} â†’ ${status}${preview}`;
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    },
    clear() {
      document.getElementById('debug-log').innerHTML = '';
    },
    toggle() {
      document.getElementById('debug-panel').classList.toggle('open');
    },
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     API  â€” direct Airtable calls
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const API = {
    get baseUrl() {
      const c = State.credentials;
      return `https://api.airtable.com/v0/${c.baseId}/${encodeURIComponent(c.table)}`;
    },
    get headers() {
      return {
        'Authorization': `Bearer ${State.credentials.token}`,
        'Content-Type': 'application/json',
      };
    },

    async request(method, path, body = null) {
      const url = this.baseUrl + (path || '');
      Debug.log(method, path || '/', 'pending');
      try {
        const opts = { method, headers: this.headers };
        if (body) opts.body = JSON.stringify(body);
        const resp = await fetch(url, opts);
        const data = await resp.json().catch(() => ({}));
        Debug.log(method, path || '/', resp.status, JSON.stringify(data).slice(0, 80));
        if (!resp.ok) {
          const msg = data.error?.message || data.error || `HTTP ${resp.status}`;
          throw { status: resp.status, message: msg, body: data };
        }
        return data;
      } catch (err) {
        if (err.status) throw err;
        Debug.log(method, path || '/', 'ERROR', err.message);
        throw { status: 0, message: err.message || 'Network error', body: null };
      }
    },

    async fetchAllRecords() {
      let all = [];
      let offset = null;
      do {
        let qs = '?pageSize=100';
        if (offset) qs += `&offset=${encodeURIComponent(offset)}`;
        const data = await this.request('GET', qs);
        all = all.concat(data.records || []);
        offset = data.offset || null;
      } while (offset);
      return all;
    },

    async patchRecord(id, fields) {
      return this.request('PATCH', `/${id}`, { fields });
    },
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TOAST
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  let _toastTimer = null;
  function showToast(msg, type = 'info', duration = 2800) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = `show ${type}`;
    clearTimeout(_toastTimer);
    _toastTimer = setTimeout(() => { el.className = ''; }, duration);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STATUS BADGE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function setStatus(msg, type = '') {
    const el = document.getElementById('status-badge');
    el.textContent = msg;
    el.className = type;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOADING OVERLAY
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function setLoading(visible) {
    document.getElementById('loading-overlay').classList.toggle('visible', visible);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STATS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function updateStats(records) {
    const platforms = ['Vinted', 'Vestiaire', 'Shopify'];
    const ids = { Vinted: 'vinted', Vestiaire: 'vestiaire', Shopify: 'shopify' };
    platforms.forEach(p => {
      const pub  = records.filter(r => r.fields[p] === true).length;
      const todo = records.filter(r => !r.fields[p]).length;
      document.getElementById(`stat-${ids[p]}-pub`).textContent  = pub;
      document.getElementById(`stat-${ids[p]}-todo`).textContent = todo;
    });
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FILTERS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function applyFilters() {
    let records = State.records.slice();

    // Search
    const q = State.searchQuery.toLowerCase().trim();
    if (q) {
      records = records.filter(r => {
        const f = r.fields;
        return [f.SKU, f.Brand, f.Sottocategoria, f.Titolo_Auto]
          .some(v => v && String(v).toLowerCase().includes(q));
      });
    }

    // Status filter
    if (State.statusFilter) {
      records = records.filter(r => r.fields.Stato === State.statusFilter);
    }

    // Platform filters (OR logic: show items not on ANY of the active platforms)
    if (State.platformFilters.length > 0) {
      records = records.filter(r =>
        State.platformFilters.some(p => !r.fields[p])
      );
    }

    State.filtered = records;
    renderTable(records);
    document.getElementById('record-count').textContent =
      `${records.length} / ${State.records.length} record`;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TABLE RENDER
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function renderTable(records) {
    const tbody = document.getElementById('records-tbody');
    const empty = document.getElementById('empty-state');
    tbody.innerHTML = '';

    if (records.length === 0) {
      empty.style.display = 'block';
      document.getElementById('records-table').style.display = 'none';
      return;
    }
    empty.style.display = 'none';
    document.getElementById('records-table').style.display = '';

    records.forEach(record => {
      const f = record.fields;
      const tr = document.createElement('tr');
      tr.dataset.id = record.id;

      // SKU
      const tdSku = document.createElement('td');
      tdSku.className = 'td-sku';
      tdSku.textContent = f.SKU || 'â€”';
      tdSku.title = 'Apri dettaglio';
      tdSku.addEventListener('click', () => openModal(record));
      tr.appendChild(tdSku);

      // Foto Drive
      const tdFoto = document.createElement('td');
      tdFoto.className = 'td-foto';
      if (f['Foto Drive']) {
        const a = document.createElement('a');
        a.href = f['Foto Drive'];
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.title = 'Apri foto';
        a.textContent = 'ğŸ“·';
        tdFoto.appendChild(a);
      } else {
        tdFoto.textContent = 'â€”';
        tdFoto.style.color = 'var(--text-muted)';
      }
      tr.appendChild(tdFoto);

      // Brand
      const tdBrand = document.createElement('td');
      tdBrand.className = 'td-brand';
      tdBrand.textContent = f.Brand || 'â€”';
      tr.appendChild(tdBrand);

      // Taglia
      const tdTaglia = document.createElement('td');
      tdTaglia.textContent = f.Taglia || 'â€”';
      tdTaglia.style.color = 'var(--text-muted)';
      tr.appendChild(tdTaglia);

      // Prezzo
      const tdPrezzo = document.createElement('td');
      tdPrezzo.className = 'td-price';
      tdPrezzo.textContent = f.Prezzo_Target != null ? `â‚¬${f.Prezzo_Target}` : 'â€”';
      tr.appendChild(tdPrezzo);

      // Stato
      const tdStato = document.createElement('td');
      tdStato.className = 'td-stato';
      const stato = f.Stato || '';
      const badge = document.createElement('span');
      if (stato === 'Disponibile') badge.className = 'badge-disp';
      else if (stato === 'Venduto') badge.className = 'badge-vend';
      else badge.className = 'badge-other';
      badge.textContent = stato || 'â€”';
      tdStato.appendChild(badge);
      tr.appendChild(tdStato);

      // Platform checkboxes
      ['Vinted', 'Vestiaire', 'Shopify'].forEach(p => {
        const td = document.createElement('td');
        td.className = 'platform-checkbox-cell';
        td.dataset.platform = p;
        td.dataset.recordId = record.id;

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'platform-cb';
        cb.dataset.platform = p;
        cb.checked = !!f[p];
        cb.addEventListener('change', () => handleCheckboxChange(record.id, p, cb.checked, td, cb));
        td.appendChild(cb);

        const spinner = document.createElement('div');
        spinner.className = 'cb-spinner';
        td.appendChild(spinner);

        tr.appendChild(td);
      });

      // Dettagli button
      const tdAction = document.createElement('td');
      const btnDet = document.createElement('button');
      btnDet.className = 'btn-detail';
      btnDet.textContent = 'Dettagli';
      btnDet.addEventListener('click', () => openModal(record));
      tdAction.appendChild(btnDet);
      tr.appendChild(tdAction);

      tbody.appendChild(tr);
    });
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CHECKBOX HANDLER  â€” optimistic update
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function handleCheckboxChange(recordId, platform, newValue, cellEl, cbEl) {
    const prev = !newValue; // rollback value
    cellEl.classList.add('loading');
    cbEl.disabled = true;

    // Optimistic: update in State
    const record = State.records.find(r => r.id === recordId);
    if (record) record.fields[platform] = newValue;
    updateStats(State.records);

    try {
      await API.patchRecord(recordId, { [platform]: newValue });
      showToast(`${platform} ${newValue ? 'âœ“ attivato' : 'âœ— rimosso'}`, 'success');
    } catch (err) {
      // Rollback
      if (record) record.fields[platform] = prev;
      cbEl.checked = prev;
      updateStats(State.records);
      showToast(`Errore aggiornamento ${platform}: ${err.message}`, 'error');
    } finally {
      cellEl.classList.remove('loading');
      cbEl.disabled = false;
    }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function openModal(record) {
    const f = record.fields;
    document.getElementById('modal-title').textContent = f.Brand || f.SKU || 'Record';
    document.getElementById('modal-sku-sub').textContent = `SKU: ${f.SKU || 'â€”'}`;

    const body = document.getElementById('modal-body');
    body.innerHTML = '';

    // Photo
    if (f['Foto Drive']) {
      const isImg = /\.(jpg|jpeg|png|gif|webp)(\?|$)/i.test(f['Foto Drive']);
      if (isImg) {
        const img = document.createElement('img');
        img.src = f['Foto Drive'];
        img.className = 'modal-photo';
        img.alt = f.SKU || 'foto';
        body.appendChild(img);
      } else {
        const link = document.createElement('a');
        link.href = f['Foto Drive'];
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.className = 'modal-photo-link';
        link.textContent = 'ğŸ“· Apri foto Drive';
        body.appendChild(link);
      }
    }

    // Fields grid
    const grid = document.createElement('div');
    grid.className = 'modal-fields';

    const simpleFields = [
      ['SKU', f.SKU],
      ['Genere', f.Genere],
      ['Sottocategoria', f.Sottocategoria],
      ['Brand', f.Brand],
      ['Colore', f.Colore],
      ['Taglia', f.Taglia],
      ['Prezzo Target', f.Prezzo_Target != null ? `â‚¬${f.Prezzo_Target}` : null],
      ['Stato', f.Stato],
    ];

    simpleFields.forEach(([label, val]) => {
      if (!val && val !== 0) return;
      const div = document.createElement('div');
      div.className = 'modal-field';
      div.innerHTML = `<label>${label}</label><div class="value">${escapeHtml(String(val))}</div>`;
      grid.appendChild(div);
    });

    // Long text fields with copy
    const longFields = [
      ['Titolo Auto', f.Titolo_Auto],
      ['Descrizione Auto', f.Descrizione_Auto],
      ['Dettagli', f.Dettagli],
    ];
    longFields.forEach(([label, val]) => {
      if (!val) return;
      const div = document.createElement('div');
      div.className = 'modal-field full';
      const lbl = document.createElement('label');
      lbl.textContent = label;
      div.appendChild(lbl);

      const row = document.createElement('div');
      row.className = 'copy-row';

      const valDiv = document.createElement('div');
      valDiv.className = 'value long';
      valDiv.textContent = val;
      row.appendChild(valDiv);

      const btnCopy = document.createElement('button');
      btnCopy.className = 'btn-copy';
      btnCopy.textContent = 'Copia';
      btnCopy.addEventListener('click', () => {
        navigator.clipboard.writeText(val).then(() => {
          btnCopy.textContent = 'Copiato!';
          btnCopy.classList.add('copied');
          setTimeout(() => { btnCopy.textContent = 'Copia'; btnCopy.classList.remove('copied'); }, 2000);
        });
      });
      row.appendChild(btnCopy);
      div.appendChild(row);
      grid.appendChild(div);
    });

    body.appendChild(grid);

    // Platform pills
    const pillsRow = document.createElement('div');
    pillsRow.className = 'modal-platforms';
    ['Vinted', 'Vestiaire', 'Shopify'].forEach(p => {
      const pill = document.createElement('div');
      pill.className = `platform-pill ${p.toLowerCase()}${!f[p] ? ' inactive' : ''}`;
      pill.innerHTML = `${f[p] ? 'âœ“' : 'â—‹'} ${p}`;
      pillsRow.appendChild(pill);
    });
    body.appendChild(pillsRow);

    document.getElementById('modal-backdrop').classList.add('visible');
  }

  function closeModal() {
    document.getElementById('modal-backdrop').classList.remove('visible');
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SETUP SCREEN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function showSetup(prefill = null) {
    const screen = document.getElementById('setup-screen');
    screen.classList.add('visible');
    if (prefill) {
      document.getElementById('input-token').value   = prefill.token  || '';
      document.getElementById('input-base-id').value = prefill.baseId || '';
      document.getElementById('input-table').value   = prefill.table  || '';
    } else {
      // prefill from CONFIG defaults
      document.getElementById('input-token').value   = CONFIG.token;
      document.getElementById('input-base-id').value = CONFIG.baseId;
      document.getElementById('input-table').value   = CONFIG.table;
    }
    document.getElementById('setup-error').style.display = 'none';
  }

  function hideSetup() {
    document.getElementById('setup-screen').classList.remove('visible');
  }

  function saveSetup() {
    const token  = document.getElementById('input-token').value.trim();
    const baseId = document.getElementById('input-base-id').value.trim();
    const table  = document.getElementById('input-table').value.trim();
    const errEl  = document.getElementById('setup-error');

    if (!token || !baseId || !table) {
      errEl.textContent = 'Compila tutti i campi.';
      errEl.style.display = 'block';
      return;
    }
    const creds = { token, baseId, table };
    Storage.saveCredentials(creds);
    State.credentials = creds;
    errEl.style.display = 'none';
    hideSetup();
    loadRecords();
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOAD RECORDS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function loadRecords() {
    setLoading(true);
    setStatus('Caricamentoâ€¦', 'loading');
    try {
      const records = await API.fetchAllRecords();
      State.records = records;
      updateStats(records);
      applyFilters();
      setStatus(`${records.length} record`, 'success');
      showToast(`${records.length} record caricati`, 'success');
    } catch (err) {
      setStatus('Errore', 'error');
      showToast(`Errore: ${err.message}`, 'error', 5000);
      Debug.log('LOAD', '/records', err.status || 'ERROR', err.message);
    } finally {
      setLoading(false);
    }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     UTILITY
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function escapeHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function debounce(fn, delay) {
    let t;
    return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     EVENT LISTENERS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  document.addEventListener('DOMContentLoaded', () => {

    // Init credentials
    const saved = Storage.loadCredentials();
    State.credentials = saved || { token: CONFIG.token, baseId: CONFIG.baseId, table: CONFIG.table };

    if (!saved) {
      // First visit: show setup with CONFIG defaults
      showSetup();
    } else {
      loadRecords();
    }

    // Refresh
    document.getElementById('btn-refresh').addEventListener('click', loadRecords);

    // Settings
    document.getElementById('btn-settings').addEventListener('click', () => {
      showSetup(State.credentials);
    });

    // Save setup
    document.getElementById('btn-save-setup').addEventListener('click', saveSetup);
    document.getElementById('input-table').addEventListener('keydown', e => {
      if (e.key === 'Enter') saveSetup();
    });

    // Search
    document.getElementById('search-input').addEventListener('input',
      debounce(e => {
        State.searchQuery = e.target.value;
        applyFilters();
      }, 300)
    );

    // Status filter
    document.getElementById('status-filter').addEventListener('change', e => {
      State.statusFilter = e.target.value;
      applyFilters();
    });

    // Platform filter buttons
    document.querySelectorAll('.btn-platform').forEach(btn => {
      btn.addEventListener('click', () => {
        const p = btn.dataset.platform;
        btn.classList.toggle('active');
        if (btn.classList.contains('active')) {
          if (!State.platformFilters.includes(p)) State.platformFilters.push(p);
        } else {
          State.platformFilters = State.platformFilters.filter(x => x !== p);
        }
        applyFilters();
      });
    });

    // Modal close
    document.getElementById('btn-close-modal').addEventListener('click', closeModal);
    document.getElementById('modal-backdrop').addEventListener('click', e => {
      if (e.target === document.getElementById('modal-backdrop')) closeModal();
    });
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeModal();
    });

    // Debug panel
    document.getElementById('debug-toggle').addEventListener('click', () => Debug.toggle());
    document.getElementById('btn-clear-debug').addEventListener('click', () => Debug.clear());

    // Global errors
    window.onerror = (msg) => Debug.log('ERROR', 'window', 500, msg);
    window.onunhandledrejection = (e) => Debug.log('REJECT', 'promise', 500, e.reason?.message || String(e.reason));

    Debug.log('INIT', 'app', 200, 'Airtable Publisher ready');
  });
  </script>
</body>
</html>

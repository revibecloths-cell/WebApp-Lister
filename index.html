<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Airtable Publisher â€” INVENTARIO</title>
  <style>
    :root {
      --bg:            #0f0f0f;
      --surface:       #1a1a1a;
      --surface2:      #212121;
      --border:        #2a2a2a;
      --accent:        #6366f1;
      --accent-hover:  #4f46e5;
      --text:          #e2e2e2;
      --text-muted:    #888;
      --success:       #22c55e;
      --error:         #ef4444;
      --warning:       #f59e0b;
      --vinted:        #009688;
      --vestiaire:     #c9a96e;
      --shopify:       #96bf48;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 14px; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    a { color: var(--accent); text-decoration: none; }
    button { cursor: pointer; border: none; font-family: inherit; font-size: inherit; }
    input, select { font-family: inherit; font-size: inherit; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--surface); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* â”€â”€â”€ Header â”€â”€ */
    #header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
      display: flex;
      align-items: center;
      gap: 14px;
      height: 52px;
      position: sticky;
      top: 0;
      z-index: 100;
      flex-shrink: 0;
    }
    #header h1 { font-size: 1.1rem; font-weight: 700; letter-spacing: -0.02em; white-space: nowrap; }
    #header h1 span { color: var(--accent); }
    #status-badge {
      font-size: 0.75rem; padding: 2px 9px; border-radius: 20px;
      background: var(--surface2); color: var(--text-muted); border: 1px solid var(--border);
      transition: all .3s;
    }
    #status-badge.success { background: rgba(34,197,94,.15);  color: var(--success);  border-color: rgba(34,197,94,.3); }
    #status-badge.error   { background: rgba(239,68,68,.15);  color: var(--error);    border-color: rgba(239,68,68,.3); }
    #status-badge.loading { background: rgba(99,102,241,.15); color: var(--accent);   border-color: rgba(99,102,241,.3); }
    #header-right { margin-left: auto; display: flex; gap: 8px; }
    .btn-header {
      background: transparent; border: 1px solid var(--border);
      color: var(--text-muted); padding: 5px 10px; border-radius: 6px;
      font-size: 0.8rem; transition: all .2s;
    }
    .btn-header:hover { border-color: var(--accent); color: var(--text); }

    /* â”€â”€â”€ Stats Bar â”€â”€ */
    #stats-bar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 8px 20px;
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
      flex-shrink: 0;
    }
    .stat-group { display: flex; align-items: center; gap: 10px; }
    .stat-label {
      font-size: .72rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: .06em; padding: 2px 8px; border-radius: 4px;
    }
    .stat-label.vinted    { background: rgba(0,150,136,.2);   color: var(--vinted); }
    .stat-label.vestiaire { background: rgba(201,169,110,.2); color: var(--vestiaire); }
    .stat-label.shopify   { background: rgba(150,191,72,.2);  color: var(--shopify); }
    .stat-item { font-size: .8rem; color: var(--text-muted); }
    .stat-item strong { color: var(--text); font-weight: 600; }
    .stat-sep { color: var(--border); }

    /* â”€â”€â”€ Platform Tabs â”€â”€ */
    #tab-bar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
      display: flex;
      align-items: center;
      gap: 2px;
      flex-shrink: 0;
    }
    .btn-tab {
      position: relative;
      padding: 12px 18px;
      font-size: 0.82rem;
      font-weight: 600;
      background: transparent;
      color: var(--text-muted);
      border: none;
      border-bottom: 2px solid transparent;
      border-radius: 0;
      transition: all .2s;
      white-space: nowrap;
    }
    .btn-tab:hover { color: var(--text); }
    .btn-tab.active { color: var(--text); border-bottom-color: var(--accent); }
    .btn-tab.active.all     { color: var(--text); border-bottom-color: var(--accent); }
    .btn-tab.active.vinted    { color: var(--vinted);    border-bottom-color: var(--vinted); }
    .btn-tab.active.vestiaire { color: var(--vestiaire); border-bottom-color: var(--vestiaire); }
    .btn-tab.active.shopify   { color: var(--shopify);   border-bottom-color: var(--shopify); }
    /* count badge on tab */
    .tab-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .65rem;
      font-weight: 700;
      padding: 1px 6px;
      border-radius: 10px;
      margin-left: 6px;
      background: var(--surface2);
      color: var(--text-muted);
      min-width: 20px;
    }
    .btn-tab.active .tab-count { background: currentColor; }
    .btn-tab.active.vinted    .tab-count { background: rgba(0,150,136,.2);   color: var(--vinted); }
    .btn-tab.active.vestiaire .tab-count { background: rgba(201,169,110,.2); color: var(--vestiaire); }
    .btn-tab.active.shopify   .tab-count { background: rgba(150,191,72,.2);  color: var(--shopify); }
    .btn-tab.active.all       .tab-count { background: rgba(99,102,241,.15); color: var(--accent); }

    /* â”€â”€â”€ Main â”€â”€ */
    #main { flex: 1; display: flex; flex-direction: column; padding: 16px 20px 80px; gap: 12px; }

    /* â”€â”€â”€ Toolbar â”€â”€ */
    #toolbar { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    #search-input {
      background: var(--surface); border: 1px solid var(--border);
      color: var(--text); padding: 7px 12px; border-radius: 6px;
      width: 240px; outline: none; transition: border-color .2s;
    }
    #search-input:focus { border-color: var(--accent); }
    #search-input::placeholder { color: var(--text-muted); }
    #status-filter {
      background: var(--surface); border: 1px solid var(--border);
      color: var(--text); padding: 7px 12px; border-radius: 6px; outline: none; cursor: pointer;
    }
    #status-filter option { background: var(--surface); }
    #record-count { margin-left: auto; font-size: .8rem; color: var(--text-muted); white-space: nowrap; }

    /* â”€â”€â”€ Table Card â”€â”€ */
    #table-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 8px; overflow: hidden; flex: 1;
    }
    #table-wrapper { overflow-x: auto; overflow-y: auto; max-height: calc(100vh - 260px); }
    table { width: 100%; border-collapse: collapse; min-width: 1200px; }

    thead th {
      background: var(--surface2); padding: 10px 10px;
      text-align: left; font-size: .7rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: .07em; color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; white-space: nowrap; z-index: 3;
    }
    thead th:first-child { position: sticky; left: 0; z-index: 4; background: var(--surface2); }
    .th-vinted    { color: var(--vinted) !important; }
    .th-vestiaire { color: var(--vestiaire) !important; }
    .th-shopify   { color: var(--shopify) !important; }

    tbody tr { border-bottom: 1px solid var(--border); transition: background .15s; }
    tbody tr:hover { background: rgba(255,255,255,.03); }
    tbody tr:last-child { border-bottom: none; }
    tbody td { padding: 8px 10px; font-size: .82rem; vertical-align: middle; white-space: nowrap; }

    /* Sticky SKU */
    tbody td:first-child { position: sticky; left: 0; background: var(--surface); z-index: 2; }
    tbody tr:hover td:first-child { background: #1f1f1f; }

    td.td-sku { font-weight: 600; color: var(--accent); cursor: pointer; max-width: 110px; overflow: hidden; text-overflow: ellipsis; }
    td.td-sku:hover { text-decoration: underline; }
    td.td-muted { color: var(--text-muted); }
    td.td-brand { color: var(--text); font-weight: 500; }
    td.td-price { color: var(--success); font-weight: 600; }
    td.td-trunc { max-width: 130px; overflow: hidden; text-overflow: ellipsis; }

    /* Drive button */
    .btn-drive {
      background: transparent; border: 1px solid var(--border);
      color: var(--accent); padding: 3px 8px; border-radius: 4px;
      font-size: .75rem; transition: all .2s; white-space: nowrap;
    }
    .btn-drive:hover { border-color: var(--accent); background: rgba(99,102,241,.1); }

    /* Copy cell */
    .copy-cell { display: flex; align-items: center; gap: 5px; max-width: 200px; }
    .copy-cell-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: .8rem; color: var(--text-muted); }
    .btn-copy-inline {
      flex-shrink: 0; width: 20px; height: 20px; background: transparent;
      border: 1px solid transparent; border-radius: 4px;
      color: var(--text-muted); font-size: .7rem; line-height: 20px;
      text-align: center; padding: 0; transition: all .15s;
    }
    .btn-copy-inline:hover { border-color: var(--accent); color: var(--accent); }
    .btn-copy-inline.copied { color: var(--success); border-color: var(--success); }

    /* Platform publish checkbox */
    .platform-checkbox-cell { text-align: center; position: relative; min-width: 60px; }
    .platform-cb {
      appearance: none; -webkit-appearance: none;
      width: 20px; height: 20px; border-radius: 5px;
      border: 2px solid var(--border); background: transparent;
      cursor: pointer; position: relative; transition: all .2s; vertical-align: middle;
    }
    .platform-cb:hover { border-color: var(--text-muted); }
    .platform-cb:checked { border-color: transparent; }
    .platform-cb[data-platform="Vinted"]:checked    { background: var(--vinted);    border-color: var(--vinted); }
    .platform-cb[data-platform="Vestiaire"]:checked { background: var(--vestiaire); border-color: var(--vestiaire); }
    .platform-cb[data-platform="Shopify"]:checked   { background: var(--shopify);   border-color: var(--shopify); }
    .platform-cb:checked::after {
      content: ''; position: absolute; left: 4px; top: 1px;
      width: 8px; height: 12px;
      border: 2px solid #fff; border-top: none; border-left: none;
      transform: rotate(45deg);
    }
    .platform-cb:disabled { opacity: .5; cursor: not-allowed; }
    .cb-spinner {
      display: none; width: 16px; height: 16px;
      border: 2px solid var(--border); border-top-color: var(--accent);
      border-radius: 50%; animation: spin-abs .6s linear infinite;
      position: absolute; top: 50%; left: 50%; pointer-events: none;
    }
    .platform-checkbox-cell.loading .platform-cb { opacity: 0; }
    .platform-checkbox-cell.loading .cb-spinner  { display: block; }

    /* Detail button */
    .btn-detail {
      background: transparent; border: 1px solid var(--border);
      color: var(--text-muted); padding: 3px 8px; border-radius: 4px;
      font-size: .75rem; transition: all .2s;
    }
    .btn-detail:hover { border-color: var(--accent); color: var(--accent); }

    /* Empty / Loading */
    #empty-state { display: none; text-align: center; padding: 60px 20px; color: var(--text-muted); }
    #empty-state p { margin-top: 8px; font-size: .85rem; }
    #loading-overlay {
      display: none; position: absolute; inset: 0;
      background: rgba(15,15,15,.8); align-items: center; justify-content: center;
      z-index: 50; border-radius: 8px;
    }
    #loading-overlay.visible { display: flex; }
    .spinner-large {
      width: 36px; height: 36px;
      border: 3px solid var(--border); border-top-color: var(--accent);
      border-radius: 50%; animation: spin .8s linear infinite;
    }

    /* â”€â”€â”€ Setup Screen â”€â”€ */
    #setup-screen {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.85); z-index: 200;
      align-items: center; justify-content: center;
    }
    #setup-screen.visible { display: flex; }
    .setup-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; padding: 32px; width: 420px; max-width: 95vw;
    }
    .setup-card h2 { font-size: 1.2rem; font-weight: 700; margin-bottom: 6px; }
    .setup-card p  { color: var(--text-muted); font-size: .85rem; margin-bottom: 24px; }
    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block; font-size: .78rem; font-weight: 600;
      color: var(--text-muted); text-transform: uppercase; letter-spacing: .05em; margin-bottom: 6px;
    }
    .form-group input {
      width: 100%; background: var(--bg); border: 1px solid var(--border);
      color: var(--text); padding: 9px 12px; border-radius: 6px; outline: none; transition: border-color .2s;
    }
    .form-group input:focus { border-color: var(--accent); }
    .form-group input::placeholder { color: var(--text-muted); }
    #btn-save-setup {
      width: 100%; background: var(--accent); color: #fff;
      padding: 10px; border-radius: 6px; font-weight: 600; transition: background .2s; margin-top: 8px;
    }
    #btn-save-setup:hover { background: var(--accent-hover); }
    #setup-error { margin-top: 12px; font-size: .8rem; color: var(--error); display: none; }

    /* â”€â”€â”€ Modal â”€â”€ */
    #modal-backdrop {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.78); z-index: 300;
      align-items: flex-start; justify-content: center;
      padding: 40px 16px; overflow-y: auto;
    }
    #modal-backdrop.visible { display: flex; }
    .modal {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; width: 580px; max-width: 100%; position: relative;
    }
    .modal-header {
      display: flex; align-items: flex-start; justify-content: space-between;
      padding: 20px 24px 14px; border-bottom: 1px solid var(--border); gap: 12px;
    }
    .modal-header-left { flex: 1; min-width: 0; }
    .modal-header h3 { font-size: 1rem; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .modal-meta { display: flex; align-items: center; gap: 8px; margin-top: 5px; flex-wrap: wrap; }
    .meta-badge { font-size: .72rem; font-weight: 600; padding: 2px 8px; border-radius: 10px; }
    .meta-badge.sku  { background: rgba(99,102,241,.12); color: var(--accent); }
    .btn-close-modal { background: transparent; color: var(--text-muted); font-size: 1.4rem; line-height: 1; padding: 0 4px; transition: color .2s; flex-shrink: 0; }
    .btn-close-modal:hover { color: var(--text); }
    .modal-body { padding: 20px 24px; }
    .modal-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal-field label { display: block; font-size: .7rem; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; color: var(--text-muted); margin-bottom: 3px; }
    .modal-field .value { font-size: .88rem; color: var(--text); word-break: break-word; }
    .modal-field.full { grid-column: 1 / -1; }
    .modal-field .value.long {
      background: var(--bg); padding: 8px 10px; border-radius: 6px;
      white-space: pre-wrap; font-size: .82rem; line-height: 1.5;
      max-height: 130px; overflow-y: auto;
    }
    .copy-row { display: flex; align-items: flex-start; gap: 8px; }
    .copy-row .value { flex: 1; }
    .btn-copy {
      background: var(--surface2); border: 1px solid var(--border);
      color: var(--text-muted); padding: 4px 8px; border-radius: 4px;
      font-size: .72rem; white-space: nowrap; transition: all .2s; flex-shrink: 0;
    }
    .btn-copy:hover { border-color: var(--accent); color: var(--accent); }
    .btn-copy.copied { color: var(--success); border-color: var(--success); }
    .modal-platforms {
      display: flex; gap: 8px; flex-wrap: wrap;
      margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);
    }
    .platform-pill {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 4px 10px; border-radius: 20px; font-size: .75rem; font-weight: 600; border: 1px solid transparent;
    }
    .platform-pill.vinted    { border-color: var(--vinted);    color: var(--vinted);    background: rgba(0,150,136,.1); }
    .platform-pill.vestiaire { border-color: var(--vestiaire); color: var(--vestiaire); background: rgba(201,169,110,.1); }
    .platform-pill.shopify   { border-color: var(--shopify);   color: var(--shopify);   background: rgba(150,191,72,.1); }
    .platform-pill.inactive  { opacity: .35; }
    .modal-drive-btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      width: 100%; margin-top: 14px; padding: 10px;
      background: transparent; border: 1px solid var(--accent); color: var(--accent);
      border-radius: 6px; font-weight: 600; font-size: .85rem; transition: all .2s;
    }
    .modal-drive-btn:hover { background: rgba(99,102,241,.12); }

    /* â”€â”€â”€ Toast â”€â”€ */
    #toast {
      position: fixed; bottom: 80px; left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--surface2); border: 1px solid var(--border);
      color: var(--text); padding: 8px 16px; border-radius: 20px;
      font-size: .82rem; opacity: 0; transition: all .3s;
      pointer-events: none; z-index: 400; white-space: nowrap;
    }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    #toast.error   { border-color: var(--error);   color: var(--error); }
    #toast.success { border-color: var(--success); color: var(--success); }

    /* â”€â”€â”€ Debug Panel â”€â”€ */
    #debug-toggle {
      position: fixed; bottom: 16px; right: 16px;
      background: var(--surface2); border: 1px solid var(--border);
      color: var(--text-muted); padding: 6px 12px; border-radius: 20px;
      font-size: .78rem; z-index: 500; transition: all .2s;
    }
    #debug-toggle:hover { border-color: var(--accent); color: var(--accent); }
    #debug-panel {
      position: fixed; bottom: 0; left: 0; right: 0; height: 220px;
      background: #0a0a0a; border-top: 1px solid var(--border);
      z-index: 490; transform: translateY(100%); transition: transform .3s ease;
      display: flex; flex-direction: column;
    }
    #debug-panel.open { transform: translateY(0); }
    #debug-panel-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 6px 12px; border-bottom: 1px solid var(--border); flex-shrink: 0;
    }
    #debug-panel-header span { font-size: .72rem; color: var(--text-muted); font-family: monospace; }
    #btn-clear-debug { background: transparent; color: var(--text-muted); font-size: .72rem; border: 1px solid var(--border); padding: 2px 8px; border-radius: 4px; }
    #btn-clear-debug:hover { color: var(--error); border-color: var(--error); }
    #debug-log { flex: 1; overflow-y: auto; padding: 8px 12px; font-family: "SF Mono","Fira Code",monospace; font-size: .72rem; line-height: 1.6; }
    .log-success { color: var(--success); }
    .log-error   { color: var(--error); }
    .log-pending { color: var(--warning); }
    .log-info    { color: #888; }

    @keyframes spin     { to { transform: rotate(360deg); } }
    @keyframes spin-abs { to { transform: translate(-50%,-50%) rotate(360deg); } }

    @media (max-width: 768px) {
      #toolbar { flex-direction: column; align-items: stretch; }
      #search-input { width: 100%; }
      #record-count { margin-left: 0; }
      #tab-bar { overflow-x: auto; }
      .modal-fields { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header id="header">
    <h1>Airtable <span>Publisher</span></h1>
    <span id="status-badge">â€”</span>
    <div id="header-right">
      <button id="btn-refresh" class="btn-header">â†» Refresh</button>
      <button id="btn-settings" class="btn-header">âš™ Config</button>
    </div>
  </header>

  <!-- Stats Bar -->
  <div id="stats-bar">
    <div class="stat-group">
      <span class="stat-label vinted">Vinted</span>
      <span class="stat-item">Caricati: <strong id="stat-vinted-pub">â€”</strong></span>
      <span class="stat-sep">Â·</span>
      <span class="stat-item">Da caricare: <strong id="stat-vinted-todo">â€”</strong></span>
    </div>
    <div class="stat-group">
      <span class="stat-label vestiaire">Vestiaire</span>
      <span class="stat-item">Caricati: <strong id="stat-vestiaire-pub">â€”</strong></span>
      <span class="stat-sep">Â·</span>
      <span class="stat-item">Da caricare: <strong id="stat-vestiaire-todo">â€”</strong></span>
    </div>
    <div class="stat-group">
      <span class="stat-label shopify">Shopify</span>
      <span class="stat-item">Caricati: <strong id="stat-shopify-pub">â€”</strong></span>
      <span class="stat-sep">Â·</span>
      <span class="stat-item">Da caricare: <strong id="stat-shopify-todo">â€”</strong></span>
    </div>
  </div>

  <!-- Platform Tabs -->
  <div id="tab-bar">
    <button class="btn-tab all active" data-platform="">
      Tutti <span class="tab-count" id="tab-count-all">â€”</span>
    </button>
    <button class="btn-tab vinted" data-platform="Vinted">
      Vinted <span class="tab-count" id="tab-count-vinted">â€”</span>
    </button>
    <button class="btn-tab vestiaire" data-platform="Vestiaire">
      Vestiaire <span class="tab-count" id="tab-count-vestiaire">â€”</span>
    </button>
    <button class="btn-tab shopify" data-platform="Shopify">
      Shopify <span class="tab-count" id="tab-count-shopify">â€”</span>
    </button>
  </div>

  <!-- Main -->
  <main id="main">
    <div id="toolbar">
      <input id="search-input" type="search" placeholder="Cerca SKU, brand, colore, condizioneâ€¦" autocomplete="off" />
      <select id="status-filter">
        <option value="">Tutti gli stati</option>
      </select>
      <span id="record-count"></span>
    </div>

    <div id="table-card" style="position:relative;">
      <div id="loading-overlay"><div class="spinner-large"></div></div>
      <div id="table-wrapper">
        <table id="records-table">
          <thead id="records-thead">
            <tr>
              <th>SKU</th>
              <th>Drive</th>
              <th>Genere</th>
              <th>Sottocategoria</th>
              <th>Brand</th>
              <th>Colore</th>
              <th>Taglia</th>
              <th>Condizione</th>
              <th>Prezzo</th>
              <th>Titolo</th>
              <th>Descrizione</th>
              <th id="th-platform" style="display:none;"></th>
              <th></th>
            </tr>
          </thead>
          <tbody id="records-tbody"></tbody>
        </table>
        <div id="empty-state">
          <div style="font-size:2rem">ğŸ“¦</div>
          <p>Nessun record trovato.</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Setup -->
  <div id="setup-screen">
    <div class="setup-card">
      <h2>âš™ Configurazione</h2>
      <p>Inserisci le credenziali Airtable. Vengono salvate nel browser (localStorage).</p>
      <div class="form-group">
        <label>Airtable Token</label>
        <input id="input-token" type="password" placeholder="patXXXXXX.XXXXXXXX" />
      </div>
      <div class="form-group">
        <label>Base ID</label>
        <input id="input-base-id" type="text" placeholder="appXXXXXXXXXXXXXX" />
      </div>
      <div class="form-group">
        <label>Table Name</label>
        <input id="input-table" type="text" placeholder="INVENTARIO" />
      </div>
      <button id="btn-save-setup">Save &amp; Connect</button>
      <div id="setup-error"></div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-header-left">
          <h3 id="modal-title">Dettaglio</h3>
          <div class="modal-meta">
            <span class="meta-badge sku" id="modal-sku-badge"></span>
            <span class="meta-badge stat" id="modal-status-badge"></span>
          </div>
        </div>
        <button class="btn-close-modal" id="btn-close-modal">Ã—</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <div id="toast"></div>
  <button id="debug-toggle">ğŸ› Debug</button>
  <div id="debug-panel">
    <div id="debug-panel-header">
      <span>DEBUG LOG</span>
      <button id="btn-clear-debug">ğŸ—‘ Clear</button>
    </div>
    <div id="debug-log"></div>
  </div>

  <script>
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CONFIG  â€” edit to change credentials
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const CONFIG = {
    token:  'patkpQw8xAugxzSEF.b35606ff391e860e8f7a979a634a96bf4c2a0f3ff41911ebea8334ee4eb2f0c0',
    baseId: 'appHQYzjPD56acfMq',
    table:  'INVENTARIO',
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FIELD HELPERS
     Airtable returns different types for different field kinds:
     - AI fields (Titolo_Auto, Descrizione_Auto): { state, value, isStale }
     - Button/URL fields (Foto Drive): { label, url }
     - Multi-select (Piattaforma): string[]
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function fieldText(val) {
    if (val == null)                                  return '';
    if (typeof val === 'string')                      return val;
    if (typeof val === 'number')                      return String(val);
    if (val && typeof val === 'object' && 'value' in val) return val.value || '';  // AI field
    if (val && typeof val === 'object' && 'url'   in val) return val.url   || '';  // URL/Button
    if (Array.isArray(val))                           return val.join(', ');
    return String(val);
  }
  function fieldUrl(val) {
    if (!val) return '';
    if (typeof val === 'string') return val;
    if (val && typeof val === 'object' && 'url' in val) return val.url || '';
    return '';
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PLATFORM HELPERS â€” Piattaforma is a multi-select array
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function isOnPlatform(fields, platform) {
    const arr = fields.Piattaforma;
    return Array.isArray(arr) && arr.includes(platform);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STATE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const State = {
    records:         [],
    filtered:        [],
    searchQuery:     '',
    statusFilter:    '',
    activePlatform:  null,    // null = Tutti | 'Vinted' | 'Vestiaire' | 'Shopify'
    credentials:     null,
    statusValues:    [],
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STORAGE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const Storage = {
    KEY: 'at_pub_creds_v2',
    load() {
      try { const r = localStorage.getItem(this.KEY); return r ? JSON.parse(r) : null; }
      catch { return null; }
    },
    save(c) { localStorage.setItem(this.KEY, JSON.stringify(c)); },
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DEBUG
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const Debug = {
    log(method, endpoint, status, detail = '') {
      const el  = document.getElementById('debug-log');
      const now = new Date();
      const ts  = [now.getHours(), now.getMinutes(), now.getSeconds()]
                    .map(n => String(n).padStart(2, '0')).join(':');
      const cls = status === 'pending'                                          ? 'log-pending'
                : (typeof status === 'number' && status >= 200 && status < 300) ? 'log-success'
                : (typeof status === 'number' && status >= 400)                 ? 'log-error'
                : status === 'ERROR'                                            ? 'log-error'
                : 'log-info';
      const line = document.createElement('div');
      line.className   = cls;
      line.textContent = `[${ts}] ${String(method).padEnd(6)} ${endpoint} â†’ ${status}` +
                         (detail ? ` | ${String(detail).slice(0, 70)}` : '');
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    },
    clear()  { document.getElementById('debug-log').innerHTML = ''; },
    toggle() { document.getElementById('debug-panel').classList.toggle('open'); },
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     UTILITIES
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function esc(str) {
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  function trunc(str, len) {
    if (!str) return '';
    return str.length > len ? str.slice(0, len) + 'â€¦' : str;
  }
  function debounce(fn, ms) {
    let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); };
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TOAST & STATUS BADGE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  let _toastT = null;
  function showToast(msg, type = 'info', ms = 2600) {
    const el = document.getElementById('toast');
    el.textContent = msg; el.className = `show ${type}`;
    clearTimeout(_toastT); _toastT = setTimeout(() => { el.className = ''; }, ms);
  }
  function setStatus(msg, type = '') {
    const el = document.getElementById('status-badge');
    el.textContent = msg; el.className = type;
  }
  function setLoading(v) {
    document.getElementById('loading-overlay').classList.toggle('visible', v);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STATUS BADGE STYLE HELPER
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const STATUS_STYLES = {
    'Disponibile': 'background:rgba(34,197,94,.15);color:var(--success)',
    'Venduto':     'background:rgba(239,68,68,.15);color:var(--error)',
    'Fare Foto':   'background:rgba(245,158,11,.15);color:var(--warning)',
  };
  function statusStyle(v) {
    return STATUS_STYLES[v] || 'background:rgba(136,136,136,.15);color:var(--text-muted)';
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     API  â€” direct Airtable calls
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const API = {
    get baseUrl() {
      const c = State.credentials;
      return `https://api.airtable.com/v0/${c.baseId}/${encodeURIComponent(c.table)}`;
    },
    get headers() {
      return { 'Authorization': `Bearer ${State.credentials.token}`, 'Content-Type': 'application/json' };
    },
    async request(method, path, body = null) {
      const url = this.baseUrl + (path || '');
      Debug.log(method, path || '/', 'pending');
      try {
        const opts = { method, headers: this.headers };
        if (body) opts.body = JSON.stringify(body);
        const resp = await fetch(url, opts);
        let data = {};
        try { data = await resp.json(); } catch { /**/ }
        Debug.log(method, path || '/', resp.status, JSON.stringify(data).slice(0, 80));
        if (!resp.ok) {
          const msg = (data.error && data.error.message) || data.error || `HTTP ${resp.status}`;
          throw { status: resp.status, message: msg, body: data };
        }
        return data;
      } catch (err) {
        if (err.status) throw err;
        const msg = err.message || 'Network error';
        Debug.log(method, path || '/', 'ERROR', msg);
        throw { status: 0, message: msg };
      }
    },
    async fetchAllRecords() {
      let all = [], offset = null;
      do {
        const data = await this.request('GET',
          `?pageSize=100${offset ? '&offset=' + encodeURIComponent(offset) : ''}`);
        all    = all.concat(data.records || []);
        offset = data.offset || null;
      } while (offset);
      return all;
    },
    async patchRecord(id, fields) {
      return this.request('PATCH', `/${id}`, { fields });
    },
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STATS  â€” based on Piattaforma multi-select
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function updateStats(records) {
    [['Vinted','vinted'],['Vestiaire','vestiaire'],['Shopify','shopify']].forEach(([p, id]) => {
      const caricati   = records.filter(r =>  isOnPlatform(r.fields, p)).length;
      const daCarica   = records.filter(r => !isOnPlatform(r.fields, p)).length;
      document.getElementById(`stat-${id}-pub`).textContent  = caricati;
      document.getElementById(`stat-${id}-todo`).textContent = daCarica;
    });
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB COUNTS  â€” how many records are "da caricare" per platform
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function updateTabCounts(records) {
    document.getElementById('tab-count-all').textContent       = records.length;
    ['Vinted','Vestiaire','Shopify'].forEach(p => {
      const id  = p.toLowerCase();
      const cnt = records.filter(r => !isOnPlatform(r.fields, p)).length;
      document.getElementById(`tab-count-${id}`).textContent = cnt;
    });
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STATUS FILTER  â€” populate dropdown from actual data
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function populateStatusFilter(records) {
    const vals = [...new Set(records.map(r => r.fields.Status).filter(Boolean))].sort();
    State.statusValues = vals;
    const sel = document.getElementById('status-filter');
    while (sel.options.length > 1) sel.remove(1);
    vals.forEach(v => {
      const o = document.createElement('option');
      o.value = v; o.textContent = v; sel.appendChild(o);
    });
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PLATFORM COLUMN HEADER â€” show/hide and style dynamically
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function updatePlatformHeader(platform) {
    const th = document.getElementById('th-platform');
    if (!platform) {
      th.style.display = 'none';
      return;
    }
    th.style.display = '';
    th.textContent   = platform;
    th.className     = `th-${platform.toLowerCase()}`;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FILTERS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function applyFilters() {
    let recs = State.records.slice();

    // Text search
    const q = State.searchQuery.toLowerCase().trim();
    if (q) {
      recs = recs.filter(r => {
        const f = r.fields;
        return [f.SKU, f.Brand, f.Sottocategoria, f.Genere, f.Colore, f.Condizione,
                fieldText(f.Titolo_Auto)]
          .some(v => v && String(v).toLowerCase().includes(q));
      });
    }

    // Status filter
    if (State.statusFilter) {
      recs = recs.filter(r => r.fields.Status === State.statusFilter);
    }

    // Platform tab filter: show records NOT yet on the active platform
    if (State.activePlatform) {
      recs = recs.filter(r => !isOnPlatform(r.fields, State.activePlatform));
    }

    State.filtered = recs;
    renderTable(recs);
    document.getElementById('record-count').textContent =
      `${recs.length} / ${State.records.length} record`;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INLINE COPY CELL
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function makeCopyCell(rawVal, truncLen) {
    const td   = document.createElement('td');
    const text = fieldText(rawVal);
    if (!text) { td.textContent = 'â€”'; td.className = 'td-muted'; return td; }

    const wrap = document.createElement('div');
    wrap.className = 'copy-cell';

    const span = document.createElement('span');
    span.className   = 'copy-cell-text';
    span.textContent = trunc(text, truncLen || 45);
    span.title       = text;
    wrap.appendChild(span);

    const btn = document.createElement('button');
    btn.className   = 'btn-copy-inline';
    btn.textContent = 'ğŸ“‹';
    btn.title       = 'Copia testo completo';
    btn.addEventListener('click', e => {
      e.stopPropagation();
      navigator.clipboard.writeText(text).then(() => {
        btn.textContent = 'âœ“'; btn.classList.add('copied');
        showToast('Copiato!', 'success', 1600);
        setTimeout(() => { btn.textContent = 'ğŸ“‹'; btn.classList.remove('copied'); }, 1500);
      }).catch(() => showToast('Copia non riuscita', 'error'));
    });
    wrap.appendChild(btn);
    td.appendChild(wrap);
    return td;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TABLE RENDER
     Column order:
     1 SKU (sticky) | 2 Drive | 3 Genere | 4 Sottocategoria |
     5 Brand | 6 Colore | 7 Taglia | 8 Condizione | 9 Prezzo |
     10 Titolo (copy) | 11 Descrizione (copy) |
     12 [Platform CB â€” only when activePlatform] | 13 Â·Â·Â·
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function renderTable(records) {
    const tbody = document.getElementById('records-tbody');
    const empty = document.getElementById('empty-state');
    tbody.innerHTML = '';

    if (!records.length) {
      empty.style.display = 'block';
      document.getElementById('records-table').style.display = 'none';
      return;
    }
    empty.style.display = 'none';
    document.getElementById('records-table').style.display = '';

    const platform = State.activePlatform;

    records.forEach(record => {
      const f  = record.fields;
      const tr = document.createElement('tr');
      tr.dataset.id = record.id;

      /* 1 â€” SKU sticky */
      const tdSku = document.createElement('td');
      tdSku.className   = 'td-sku';
      tdSku.textContent = f.SKU || 'â€”';
      tdSku.title       = 'Apri dettaglio';
      tdSku.addEventListener('click', () => openModal(record));
      tr.appendChild(tdSku);

      /* 2 â€” Drive (Foto Drive Button field â†’ {label, url}) */
      const tdDrive  = document.createElement('td');
      const driveUrl = fieldUrl(f['Foto Drive']);
      if (driveUrl) {
        const btn = document.createElement('button');
        btn.className   = 'btn-drive';
        btn.textContent = 'ğŸ“';
        btn.title       = driveUrl;
        btn.addEventListener('click', e => { e.stopPropagation(); openDriveFolder(driveUrl); });
        tdDrive.appendChild(btn);
      } else {
        tdDrive.textContent = 'â€”'; tdDrive.className = 'td-muted';
      }
      tr.appendChild(tdDrive);

      /* 3 â€” Genere */
      const tdG = document.createElement('td');
      tdG.className = 'td-muted td-trunc'; tdG.textContent = f.Genere || 'â€”'; tr.appendChild(tdG);

      /* 4 â€” Sottocategoria */
      const tdSc = document.createElement('td');
      tdSc.className = 'td-muted td-trunc'; tdSc.textContent = f.Sottocategoria || 'â€”'; tr.appendChild(tdSc);

      /* 5 â€” Brand */
      const tdBr = document.createElement('td');
      tdBr.className = 'td-brand'; tdBr.textContent = f.Brand || 'â€”'; tr.appendChild(tdBr);

      /* 6 â€” Colore */
      const tdCo = document.createElement('td');
      tdCo.className = 'td-muted'; tdCo.textContent = f.Colore || 'â€”'; tr.appendChild(tdCo);

      /* 7 â€” Taglia */
      const tdTa = document.createElement('td');
      tdTa.className = 'td-muted'; tdTa.textContent = f.Taglia || 'â€”'; tr.appendChild(tdTa);

      /* 8 â€” Condizione */
      const tdCn = document.createElement('td');
      tdCn.className = 'td-muted'; tdCn.textContent = f.Condizione || 'â€”'; tr.appendChild(tdCn);

      /* 9 â€” Prezzo */
      const tdPr = document.createElement('td');
      tdPr.className   = 'td-price';
      tdPr.textContent = (f.Prezzo_Target != null) ? `â‚¬${f.Prezzo_Target}` : 'â€”';
      tr.appendChild(tdPr);

      /* 10 â€” Titolo_Auto (AI field + copy) */
      tr.appendChild(makeCopyCell(f.Titolo_Auto, 48));

      /* 11 â€” Descrizione_Auto (AI field + copy) */
      tr.appendChild(makeCopyCell(f.Descrizione_Auto, 48));

      /* 12 â€” Platform publish checkbox (only when on platform tab) */
      if (platform) {
        const tdCb = document.createElement('td');
        tdCb.className        = 'platform-checkbox-cell';
        tdCb.dataset.platform = platform;
        tdCb.dataset.recordId = record.id;

        const cb = document.createElement('input');
        cb.type             = 'checkbox';
        cb.className        = 'platform-cb';
        cb.dataset.platform = platform;
        cb.checked          = false;   // always unchecked â€” filter shows NOT on platform
        cb.addEventListener('change', () => {
          if (cb.checked) handlePublish(record.id, platform, tdCb, cb);
          else            cb.checked = false;  // prevent unchecking (one-way action)
        });
        tdCb.appendChild(cb);

        const spin = document.createElement('div');
        spin.className = 'cb-spinner';
        tdCb.appendChild(spin);

        tr.appendChild(tdCb);
      }

      /* 13 â€” Modal button */
      const tdAct  = document.createElement('td');
      const btnDet = document.createElement('button');
      btnDet.className   = 'btn-detail';
      btnDet.textContent = 'Â·Â·Â·';
      btnDet.title       = 'Apri dettaglio completo';
      btnDet.addEventListener('click', () => openModal(record));
      tdAct.appendChild(btnDet);
      tr.appendChild(tdAct);

      tbody.appendChild(tr);
    });
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DRIVE FOLDER OPEN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function openDriveFolder(url) {
    if (!url) return;
    const m = url.match(/\/folders\/([a-zA-Z0-9_-]+)/);
    const openUrl = m
      ? `https://drive.google.com/drive/folders/${m[1]}?usp=sharing`
      : url;
    window.open(openUrl, '_blank', 'noopener,noreferrer');
    Debug.log('DRIVE', '/open', 200, url.slice(0, 60));
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HANDLE PUBLISH â€” adds platform to Piattaforma array
     (one-way action: marks product as uploaded to this platform)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function handlePublish(recordId, platform, cellEl, cbEl) {
    const record = State.records.find(r => r.id === recordId);
    if (!record) return;

    const prevArr = Array.isArray(record.fields.Piattaforma) ? [...record.fields.Piattaforma] : [];
    const newArr  = [...new Set([...prevArr, platform])];

    // Optimistic update
    record.fields.Piattaforma = newArr;
    cellEl.classList.add('loading');
    cbEl.disabled = true;
    updateStats(State.records);
    updateTabCounts(State.records);

    try {
      await API.patchRecord(recordId, { Piattaforma: newArr });
      showToast(`âœ“ ${f_sku(record)} pubblicato su ${platform}`, 'success');
      // Re-apply filter â€” record disappears (now it's in the platform)
      applyFilters();
    } catch (err) {
      // Rollback
      record.fields.Piattaforma = prevArr;
      cbEl.checked   = false;
      updateStats(State.records);
      updateTabCounts(State.records);
      showToast(`Errore ${platform}: ${err.message}`, 'error');
      cellEl.classList.remove('loading');
      cbEl.disabled = false;
    }
  }

  function f_sku(record) {
    return (record && record.fields && record.fields.SKU) ? record.fields.SKU : 'record';
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function openModal(record) {
    const f = record.fields;
    document.getElementById('modal-title').textContent = f.Brand || f.SKU || 'Record';

    const skuBadge = document.getElementById('modal-sku-badge');
    skuBadge.textContent = `SKU: ${f.SKU || 'â€”'}`;

    const stBadge = document.getElementById('modal-status-badge');
    const status  = f.Status || '';
    if (status) {
      stBadge.textContent   = status;
      stBadge.style.cssText = `${statusStyle(status)}; padding: 2px 8px; border-radius: 10px; font-size: .72rem; font-weight: 600;`;
      stBadge.style.display = '';
    } else {
      stBadge.style.display = 'none';
    }

    const body = document.getElementById('modal-body');
    body.innerHTML = '';

    // Simple grid
    const grid = document.createElement('div');
    grid.className = 'modal-fields';
    [
      ['Genere',         f.Genere],
      ['Sottocategoria', f.Sottocategoria],
      ['Brand',          f.Brand],
      ['Colore',         f.Colore],
      ['Taglia',         f.Taglia],
      ['Condizione',     f.Condizione],
      ['Prezzo Target',  f.Prezzo_Target != null ? `â‚¬${f.Prezzo_Target}` : null],
    ].forEach(([label, val]) => {
      if (val == null || val === '') return;
      const d = document.createElement('div');
      d.className = 'modal-field';
      d.innerHTML = `<label>${esc(label)}</label><div class="value">${esc(String(val))}</div>`;
      grid.appendChild(d);
    });
    body.appendChild(grid);

    // Long text fields
    [
      ['Titolo Auto',      f.Titolo_Auto],
      ['Descrizione Auto', f.Descrizione_Auto],
      ['Dettagli',         f.Dettagli],
    ].forEach(([label, rawVal]) => {
      const text = fieldText(rawVal);
      if (!text) return;
      const d   = document.createElement('div');
      d.className = 'modal-field full';
      const lbl = document.createElement('label');
      lbl.textContent = label; d.appendChild(lbl);
      const row = document.createElement('div');
      row.className = 'copy-row';
      const v = document.createElement('div');
      v.className = 'value long'; v.textContent = text;
      row.appendChild(v);
      const btn = document.createElement('button');
      btn.className = 'btn-copy'; btn.textContent = 'Copia';
      btn.addEventListener('click', () => {
        navigator.clipboard.writeText(text).then(() => {
          btn.textContent = 'Copiato âœ“'; btn.classList.add('copied');
          showToast('Copiato!', 'success', 1600);
          setTimeout(() => { btn.textContent = 'Copia'; btn.classList.remove('copied'); }, 2000);
        }).catch(() => showToast('Copia non riuscita', 'error'));
      });
      row.appendChild(btn); d.appendChild(row); body.appendChild(d);
    });

    // Platform pills
    const pillsRow = document.createElement('div');
    pillsRow.className = 'modal-platforms';
    ['Vinted', 'Vestiaire', 'Shopify'].forEach(p => {
      const on   = isOnPlatform(f, p);
      const pill = document.createElement('div');
      pill.className   = `platform-pill ${p.toLowerCase()}${!on ? ' inactive' : ''}`;
      pill.textContent = `${on ? 'âœ“' : 'â—‹'} ${p}`;
      pillsRow.appendChild(pill);
    });
    body.appendChild(pillsRow);

    // Drive button
    const driveUrl = fieldUrl(f['Foto Drive']);
    if (driveUrl) {
      const btn = document.createElement('button');
      btn.className   = 'modal-drive-btn';
      btn.textContent = 'ğŸ“ Apri cartella Drive';
      btn.addEventListener('click', () => openDriveFolder(driveUrl));
      body.appendChild(btn);
    }

    document.getElementById('modal-backdrop').classList.add('visible');
  }

  function closeModal() {
    document.getElementById('modal-backdrop').classList.remove('visible');
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SETUP SCREEN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function showSetup(prefill) {
    document.getElementById('setup-screen').classList.add('visible');
    const c = prefill || { token: CONFIG.token, baseId: CONFIG.baseId, table: CONFIG.table };
    document.getElementById('input-token').value   = c.token  || '';
    document.getElementById('input-base-id').value = c.baseId || '';
    document.getElementById('input-table').value   = c.table  || '';
    document.getElementById('setup-error').style.display = 'none';
  }
  function hideSetup() { document.getElementById('setup-screen').classList.remove('visible'); }
  function saveSetup() {
    const token  = document.getElementById('input-token').value.trim();
    const baseId = document.getElementById('input-base-id').value.trim();
    const table  = document.getElementById('input-table').value.trim();
    const errEl  = document.getElementById('setup-error');
    if (!token || !baseId || !table) {
      errEl.textContent = 'Compila tutti i campi.'; errEl.style.display = 'block'; return;
    }
    const creds = { token, baseId, table };
    Storage.save(creds);
    State.credentials = creds;
    errEl.style.display = 'none';
    hideSetup();
    loadRecords();
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOAD RECORDS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function loadRecords() {
    setLoading(true);
    setStatus('Caricamentoâ€¦', 'loading');
    try {
      const records = await API.fetchAllRecords();
      State.records = records;
      updateStats(records);
      updateTabCounts(records);
      populateStatusFilter(records);
      applyFilters();
      setStatus(`${records.length} record`, 'success');
      showToast(`${records.length} record caricati`, 'success');
    } catch (err) {
      setStatus('Errore', 'error');
      showToast(`Errore: ${err.message || err}`, 'error', 5000);
    } finally {
      setLoading(false);
    }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INIT
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  document.addEventListener('DOMContentLoaded', () => {
    const saved = Storage.load();
    State.credentials = saved || { token: CONFIG.token, baseId: CONFIG.baseId, table: CONFIG.table };
    if (!saved) { showSetup(); } else { loadRecords(); }

    // Header
    document.getElementById('btn-refresh').addEventListener('click', loadRecords);
    document.getElementById('btn-settings').addEventListener('click', () => showSetup(State.credentials));

    // Setup form
    document.getElementById('btn-save-setup').addEventListener('click', saveSetup);
    document.getElementById('input-table').addEventListener('keydown', e => { if (e.key === 'Enter') saveSetup(); });

    // Search
    document.getElementById('search-input').addEventListener('input',
      debounce(e => { State.searchQuery = e.target.value; applyFilters(); }, 300)
    );

    // Status filter
    document.getElementById('status-filter').addEventListener('change', e => {
      State.statusFilter = e.target.value; applyFilters();
    });

    // Platform tabs â€” EXCLUSIVE selection
    document.querySelectorAll('.btn-tab').forEach(btn => {
      btn.addEventListener('click', () => {
        // Remove active from all
        document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        State.activePlatform = btn.dataset.platform || null;
        updatePlatformHeader(State.activePlatform);
        applyFilters();
      });
    });

    // Modal close
    document.getElementById('btn-close-modal').addEventListener('click', closeModal);
    document.getElementById('modal-backdrop').addEventListener('click', e => {
      if (e.target === document.getElementById('modal-backdrop')) closeModal();
    });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    // Debug
    document.getElementById('debug-toggle').addEventListener('click', () => Debug.toggle());
    document.getElementById('btn-clear-debug').addEventListener('click', () => Debug.clear());

    window.onerror             = (msg, s, line) => Debug.log('ERROR',  `window:${line}`, 500, String(msg).slice(0,100));
    window.onunhandledrejection = e             => Debug.log('REJECT', 'promise',         500,
        ((e.reason && e.reason.message) ? e.reason.message : String(e.reason)).slice(0,100));

    Debug.log('INIT', 'app', 200, 'Airtable Publisher v4 â€” ready');
  });
  </script>
</body>
</html>

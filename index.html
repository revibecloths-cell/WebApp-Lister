<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revibe ‚Äî Upload Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --bg-hover: #222222;
            --border: #2a2a2a;
            --border-light: #333333;
            --text-primary: #f0f0f0;
            --text-secondary: #888888;
            --text-muted: #555555;
            --accent-vinted: #09b1ba;
            --accent-vestiaire: #d4a853;
            --accent-shopify: #96bf48;
            --accent-vinted-bg: rgba(9, 177, 186, 0.08);
            --accent-vestiaire-bg: rgba(212, 168, 83, 0.08);
            --accent-shopify-bg: rgba(150, 191, 72, 0.08);
            --danger: #e54d4d;
            --success: #4ecf73;
            --font-main: 'DM Sans', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --radius: 8px;
            --radius-sm: 5px;
            --radius-lg: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* Setup Screen */
        .setup-overlay {
            position: fixed; inset: 0;
            background: var(--bg-primary);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
        }

        .setup-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 48px;
            max-width: 480px;
            width: 90%;
        }

        .setup-card h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 6px;
        }

        .setup-card .subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 32px;
        }

        .setup-card label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .setup-card input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 13px;
            margin-bottom: 20px;
            outline: none;
            transition: border-color 0.2s;
        }

        .setup-card input:focus { border-color: var(--text-muted); }

        .setup-card input::placeholder { color: var(--text-muted); }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: var(--text-primary);
            color: var(--bg-primary);
            border: none;
            border-radius: var(--radius);
            font-family: var(--font-main);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn-primary:hover { opacity: 0.85; }
        .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }

        .setup-error {
            background: rgba(229, 77, 77, 0.1);
            border: 1px solid rgba(229, 77, 77, 0.2);
            color: var(--danger);
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            margin-bottom: 16px;
        }

        /* Header */
        .header {
            padding: 20px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: rgba(10, 10, 10, 0.92);
            backdrop-filter: blur(12px);
            z-index: 100;
        }

        .header-left { display: flex; align-items: center; gap: 20px; }

        .logo {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .logo span { color: var(--text-muted); font-weight: 400; }

        .header-stats {
            display: flex; gap: 16px;
            font-size: 12px; color: var(--text-secondary);
            font-family: var(--font-mono);
        }

        .header-stats .stat-val { color: var(--text-primary); font-weight: 500; }

        .header-right { display: flex; align-items: center; gap: 12px; }

        .btn-icon {
            width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s;
        }

        .btn-icon:hover { background: var(--bg-hover); color: var(--text-primary); }

        /* Toolbar */
        .toolbar {
            padding: 16px 32px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            flex: 0 0 260px;
        }

        .search-box input {
            width: 100%;
            padding: 9px 12px 9px 36px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-family: var(--font-main);
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-box input:focus { border-color: var(--text-muted); }
        .search-box input::placeholder { color: var(--text-muted); }

        .search-box .search-icon {
            position: absolute;
            left: 12px; top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 13px;
            pointer-events: none;
        }

        .divider-v {
            width: 1px; height: 28px;
            background: var(--border);
            margin: 0 4px;
        }

        .filter-group {
            display: flex; gap: 6px;
            align-items: center;
        }

        .filter-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-right: 4px;
            font-weight: 600;
        }

        .filter-btn {
            padding: 7px 16px;
            border-radius: 100px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            font-family: var(--font-main);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .filter-btn:hover { border-color: var(--border-light); color: var(--text-primary); }

        .filter-btn.active-vinted {
            background: var(--accent-vinted-bg);
            border-color: var(--accent-vinted);
            color: var(--accent-vinted);
        }

        .filter-btn.active-vestiaire {
            background: var(--accent-vestiaire-bg);
            border-color: var(--accent-vestiaire);
            color: var(--accent-vestiaire);
        }

        .filter-btn.active-shopify {
            background: var(--accent-shopify-bg);
            border-color: var(--accent-shopify);
            color: var(--accent-shopify);
        }

        .filter-btn .count {
            display: inline-block;
            margin-left: 6px;
            padding: 1px 7px;
            border-radius: 100px;
            font-size: 10px;
            font-family: var(--font-mono);
            background: rgba(255,255,255,0.06);
        }

        .status-filters {
            display: flex; gap: 6px;
            margin-left: auto;
        }

        .status-chip {
            padding: 5px 12px;
            border-radius: 100px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .status-chip:hover { color: var(--text-secondary); border-color: var(--border-light); }
        .status-chip.active { color: var(--text-primary); background: var(--bg-tertiary); border-color: var(--border-light); }

        /* Table */
        .table-container {
            overflow-x: auto;
            overflow-y: auto;
            max-height: calc(100vh - 150px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        thead th {
            background: var(--bg-secondary);
            padding: 10px 14px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            user-select: none;
        }

        tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.1s;
        }

        tbody tr:hover { background: var(--bg-secondary); }

        tbody td {
            padding: 10px 14px;
            vertical-align: middle;
            white-space: nowrap;
        }

        .cell-sku {
            font-family: var(--font-mono);
            font-weight: 500;
            font-size: 12px;
            color: var(--text-primary);
        }

        .cell-brand { font-weight: 600; }

        .cell-link {
            color: var(--accent-vinted);
            text-decoration: none;
            font-size: 12px;
        }

        .cell-link:hover { text-decoration: underline; }

        .cell-price {
            font-family: var(--font-mono);
            font-weight: 500;
        }

        .cell-truncate {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }

        .cell-truncate:hover {
            white-space: normal;
            position: relative;
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 500;
        }

        .badge-disponibile { background: rgba(78, 207, 115, 0.1); color: var(--success); }
        .badge-venduto { background: rgba(229, 77, 77, 0.1); color: var(--danger); }
        .badge-default { background: var(--bg-tertiary); color: var(--text-secondary); }

        .badge-genere {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-weight: 600;
        }

        .badge-uomo { background: rgba(100, 149, 237, 0.12); color: #6495ed; }
        .badge-donna { background: rgba(219, 112, 147, 0.12); color: #db7093; }

        /* Checkboxes */
        .check-group { display: flex; gap: 8px; align-items: center; }

        .platform-check {
            position: relative;
            width: 18px; height: 18px;
        }

        .platform-check input {
            position: absolute;
            opacity: 0;
            width: 100%; height: 100%;
            cursor: pointer;
            z-index: 2;
        }

        .platform-check .checkmark {
            position: absolute; inset: 0;
            border: 1.5px solid var(--border-light);
            border-radius: 4px;
            background: transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .platform-check .checkmark::after {
            content: '‚úì';
            font-size: 11px;
            color: transparent;
            transition: color 0.15s;
            font-weight: 700;
        }

        .platform-check input:checked + .checkmark.check-vinted {
            background: var(--accent-vinted-bg);
            border-color: var(--accent-vinted);
        }
        .platform-check input:checked + .checkmark.check-vinted::after { color: var(--accent-vinted); }

        .platform-check input:checked + .checkmark.check-vestiaire {
            background: var(--accent-vestiaire-bg);
            border-color: var(--accent-vestiaire);
        }
        .platform-check input:checked + .checkmark.check-vestiaire::after { color: var(--accent-vestiaire); }

        .platform-check input:checked + .checkmark.check-shopify {
            background: var(--accent-shopify-bg);
            border-color: var(--accent-shopify);
        }
        .platform-check input:checked + .checkmark.check-shopify::after { color: var(--accent-shopify); }

        .platform-check.saving .checkmark {
            opacity: 0.5;
            animation: pulse 0.6s ease-in-out infinite alternate;
        }

        @keyframes pulse { from { opacity: 0.3; } to { opacity: 0.7; } }

        .check-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: var(--text-muted);
            font-weight: 600;
        }

        /* Detail Modal */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center; justify-content: center;
            z-index: 500;
            animation: fadeIn 0.15s ease;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .modal-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            max-width: 640px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 32px;
            animation: slideUp 0.2s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(12px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex; align-items: flex-start; justify-content: space-between;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 18px; font-weight: 700;
            letter-spacing: -0.3px;
        }

        .modal-header .sku-tag {
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .modal-close {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 32px; height: 32px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 16px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.15s;
        }

        .modal-close:hover { background: var(--bg-hover); color: var(--text-primary); }

        .modal-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .modal-field label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: var(--text-muted);
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .modal-field .value {
            font-size: 14px;
            color: var(--text-primary);
        }

        .modal-desc {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
            white-space: pre-wrap;
            max-height: 240px;
            overflow-y: auto;
        }

        .modal-section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 8px;
        }

        /* Loading */
        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60vh;
            gap: 16px;
        }

        .spinner {
            width: 28px; height: 28px;
            border: 2px solid var(--border);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-muted);
        }

        .empty-state .icon { font-size: 32px; margin-bottom: 12px; }
        .empty-state p { font-size: 14px; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px; right: 24px;
            padding: 12px 20px;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 500;
            z-index: 600;
            animation: slideIn 0.2s ease, fadeOut 0.3s ease 2.5s forwards;
        }

        .toast-success { background: rgba(78, 207, 115, 0.15); color: var(--success); border: 1px solid rgba(78, 207, 115, 0.2); }
        .toast-error { background: rgba(229, 77, 77, 0.15); color: var(--danger); border: 1px solid rgba(229, 77, 77, 0.2); }

        @keyframes slideIn { from { transform: translateX(40px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; } }

        /* Responsive */
        @media (max-width: 768px) {
            .header { padding: 16px; }
            .toolbar { padding: 12px 16px; }
            .search-box { flex: 1 1 100%; }
            .filter-group { flex-wrap: wrap; }
            .modal-grid { grid-template-columns: 1fr; }
            .header-stats { display: none; }
            .status-filters { display: none; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;

        // ‚îÄ‚îÄ‚îÄ Airtable API Helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        class AirtableClient {
            constructor(token, baseId, tableName) {
                this.token = token;
                this.baseId = baseId;
                this.tableName = tableName;
                this.baseUrl = `https://api.airtable.com/v0/${baseId}/${encodeURIComponent(tableName)}`;
            }

            async fetchAll() {
                let allRecords = [];
                let offset = null;

                do {
                    const url = new URL(this.baseUrl);
                    if (offset) url.searchParams.set('offset', offset);
                    url.searchParams.set('pageSize', '100');

                    const res = await fetch(url.toString(), {
                        headers: { Authorization: `Bearer ${this.token}` }
                    });

                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        throw new Error(err.error?.message || `HTTP ${res.status}`);
                    }

                    const data = await res.json();
                    allRecords = allRecords.concat(data.records);
                    offset = data.offset;
                } while (offset);

                return allRecords;
            }

            async updateRecord(recordId, fields) {
                const res = await fetch(`${this.baseUrl}/${recordId}`, {
                    method: 'PATCH',
                    headers: {
                        Authorization: `Bearer ${this.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fields })
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.error?.message || `HTTP ${res.status}`);
                }

                return await res.json();
            }
        }

        // ‚îÄ‚îÄ‚îÄ Toast Component ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function Toast({ message, type, onDone }) {
            useEffect(() => {
                const t = setTimeout(onDone, 3000);
                return () => clearTimeout(t);
            }, []);

            return <div className={`toast toast-${type}`}>{message}</div>;
        }

        // ‚îÄ‚îÄ‚îÄ Setup Screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function SetupScreen({ onConnect }) {
            const [token, setToken] = useState(() => localStorage.getItem('dt_token') || '');
            const [baseId, setBaseId] = useState(() => localStorage.getItem('dt_baseId') || '');
            const [tableName, setTableName] = useState(() => localStorage.getItem('dt_tableName') || 'inventario');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleConnect = async () => {
                setLoading(true);
                setError('');
                try {
                    const client = new AirtableClient(token.trim(), baseId.trim(), tableName.trim());
                    const records = await client.fetchAll();
                    localStorage.setItem('dt_token', token.trim());
                    localStorage.setItem('dt_baseId', baseId.trim());
                    localStorage.setItem('dt_tableName', tableName.trim());
                    onConnect(client, records);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="setup-overlay">
                    <div className="setup-card">
                        <h1>Revibe</h1>
                        <p className="subtitle">Upload Dashboard ‚Äî Connetti Airtable</p>

                        {error && <div className="setup-error">‚ö† {error}</div>}

                        <label>Personal Access Token</label>
                        <input
                            type="password"
                            placeholder="pat_xxxxxxxxxxxx..."
                            value={token}
                            onChange={e => setToken(e.target.value)}
                        />

                        <label>Base ID</label>
                        <input
                            placeholder="appXXXXXXXXXXXXXX"
                            value={baseId}
                            onChange={e => setBaseId(e.target.value)}
                        />

                        <label>Nome Tabella</label>
                        <input
                            placeholder="inventario"
                            value={tableName}
                            onChange={e => setTableName(e.target.value)}
                        />

                        <button
                            className="btn-primary"
                            onClick={handleConnect}
                            disabled={loading || !token || !baseId || !tableName}
                        >
                            {loading ? 'Connessione...' : 'Connetti'}
                        </button>
                    </div>
                </div>
            );
        }

        // ‚îÄ‚îÄ‚îÄ Detail Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function DetailModal({ record, onClose }) {
            const f = record.fields;

            useEffect(() => {
                const handleEsc = e => e.key === 'Escape' && onClose();
                window.addEventListener('keydown', handleEsc);
                return () => window.removeEventListener('keydown', handleEsc);
            }, []);

            return (
                <div className="modal-overlay" onClick={e => e.target === e.currentTarget && onClose()}>
                    <div className="modal-card">
                        <div className="modal-header">
                            <div>
                                <h2>{f['Brand']} ‚Äî {f['Categoria']}</h2>
                                <div className="sku-tag">{f['SKU']}</div>
                            </div>
                            <button className="modal-close" onClick={onClose}>‚úï</button>
                        </div>

                        <div className="modal-grid">
                            <div className="modal-field">
                                <label>Genere</label>
                                <div className="value">{f['Genere'] || '‚Äî'}</div>
                            </div>
                            <div className="modal-field">
                                <label>Taglia</label>
                                <div className="value">{f['Taglia'] || '‚Äî'}</div>
                            </div>
                            <div className="modal-field">
                                <label>Colore</label>
                                <div className="value">{f['Colore'] || '‚Äî'}</div>
                            </div>
                            <div className="modal-field">
                                <label>Condizione</label>
                                <div className="value">{f['Condizione'] || '‚Äî'}</div>
                            </div>
                            <div className="modal-field">
                                <label>Prezzo Target</label>
                                <div className="value">{f['Prezzo_Target'] || '‚Äî'}</div>
                            </div>
                            <div className="modal-field">
                                <label>Status</label>
                                <div className="value">{f['Status'] || '‚Äî'}</div>
                            </div>
                            <div className="modal-field">
                                <label>Piattaforma</label>
                                <div className="value">{f['Piattaforma'] || '‚Äî'}</div>
                            </div>
                            <div className="modal-field">
                                <label>Foto Drive</label>
                                <div className="value">
                                    {f['Foto Drive'] || f['Drive_Folder_URL'] ? (
                                        <a className="cell-link" href={f['Foto Drive'] || f['Drive_Folder_URL']} target="_blank" rel="noopener">Apri cartella ‚Üó</a>
                                    ) : '‚Äî'}
                                </div>
                            </div>
                        </div>

                        {f['Dettagli'] && (
                            <div style={{ marginBottom: 20 }}>
                                <div className="modal-section-title">Dettagli</div>
                                <div className="modal-desc">{f['Dettagli']}</div>
                            </div>
                        )}

                        {f['Titolo_Auto'] && (
                            <div style={{ marginBottom: 20 }}>
                                <div className="modal-section-title">Titolo Auto</div>
                                <div className="modal-desc">{f['Titolo_Auto']}</div>
                            </div>
                        )}

                        {f['Descrizione_Auto'] && (
                            <div>
                                <div className="modal-section-title">Descrizione Auto</div>
                                <div className="modal-desc">{f['Descrizione_Auto']}</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ‚îÄ‚îÄ‚îÄ Main Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function Dashboard({ client, initialRecords }) {
            const [records, setRecords] = useState(initialRecords);
            const [search, setSearch] = useState('');
            const [platformFilter, setPlatformFilter] = useState(null); // null | 'Vinted' | 'Vestiaire' | 'Shopify'
            const [statusFilter, setStatusFilter] = useState(null);
            const [selectedRecord, setSelectedRecord] = useState(null);
            const [savingCells, setSavingCells] = useState(new Set());
            const [toast, setToast] = useState(null);
            const [refreshing, setRefreshing] = useState(false);

            const showToast = (message, type = 'success') => {
                setToast({ message, type, key: Date.now() });
            };

            const refresh = async () => {
                setRefreshing(true);
                try {
                    const fresh = await client.fetchAll();
                    setRecords(fresh);
                } catch (err) {
                    showToast(`Errore refresh: ${err.message}`, 'error');
                } finally {
                    setRefreshing(false);
                }
            };

            const handleCheckChange = async (recordId, field, value) => {
                const cellKey = `${recordId}-${field}`;
                setSavingCells(prev => new Set(prev).add(cellKey));

                // Optimistic update
                setRecords(prev => prev.map(r =>
                    r.id === recordId
                        ? { ...r, fields: { ...r.fields, [field]: value } }
                        : r
                ));

                try {
                    await client.updateRecord(recordId, { [field]: value });
                    showToast(`${field} aggiornato`);
                } catch (err) {
                    // Rollback
                    setRecords(prev => prev.map(r =>
                        r.id === recordId
                            ? { ...r, fields: { ...r.fields, [field]: !value } }
                            : r
                    ));
                    showToast(`Errore: ${err.message}`, 'error');
                } finally {
                    setSavingCells(prev => {
                        const next = new Set(prev);
                        next.delete(cellKey);
                        return next;
                    });
                }
            };

            const disconnect = () => {
                localStorage.removeItem('dt_token');
                localStorage.removeItem('dt_baseId');
                localStorage.removeItem('dt_tableName');
                window.location.reload();
            };

            // ‚îÄ‚îÄ‚îÄ Filtering Logic ‚îÄ‚îÄ‚îÄ‚îÄ
            const filtered = useMemo(() => {
                return records.filter(r => {
                    const f = r.fields;

                    // Search filter
                    if (search) {
                        const q = search.toLowerCase();
                        const haystack = [f['SKU'], f['Brand'], f['Categoria'], f['Sottocategoria'], f['Titolo_Auto']]
                            .filter(Boolean)
                            .join(' ')
                            .toLowerCase();
                        if (!haystack.includes(q)) return false;
                    }

                    // Platform filter (on Piattaforma multi-select field)
                    if (platformFilter) {
                        const piattaforma = f['Piattaforma'] || '';
                        // Piattaforma can be comma-separated or an array
                        const platforms = Array.isArray(piattaforma) ? piattaforma : piattaforma.split(',').map(s => s.trim());
                        if (!platforms.some(p => p.toLowerCase().includes(platformFilter.toLowerCase()))) return false;
                    }

                    // Status filter
                    if (statusFilter) {
                        if ((f['Status'] || '').toLowerCase() !== statusFilter.toLowerCase()) return false;
                    }

                    return true;
                });
            }, [records, search, platformFilter, statusFilter]);

            // ‚îÄ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ
            const stats = useMemo(() => {
                const total = records.length;
                const countPlatform = (name) => records.filter(r => {
                    const p = r.fields['Piattaforma'] || '';
                    const arr = Array.isArray(p) ? p : p.split(',').map(s => s.trim());
                    return arr.some(x => x.toLowerCase().includes(name.toLowerCase()));
                }).length;

                const uploaded = (name) => records.filter(r => r.fields[name] === true).length;

                return {
                    total,
                    vinted: countPlatform('Vinted'),
                    vestiaire: countPlatform('Vestiaire'),
                    shopify: countPlatform('Shopify'),
                    uploadedVinted: uploaded('Vinted'),
                    uploadedVestiaire: uploaded('Vestiaire'),
                    uploadedShopify: uploaded('Shopify'),
                };
            }, [records]);

            const togglePlatformFilter = (name) => {
                setPlatformFilter(prev => prev === name ? null : name);
            };

            return (
                <div>
                    {/* Header */}
                    <div className="header">
                        <div className="header-left">
                            <div className="logo">Revibe <span>/ upload</span></div>
                            <div className="header-stats">
                                <div><span className="stat-val">{stats.total}</span> prodotti</div>
                                <div>
                                    <span className="stat-val" style={{color: 'var(--accent-vinted)'}}>{stats.uploadedVinted}</span>
                                    <span>/</span>
                                    <span className="stat-val">{stats.vinted}</span> V
                                </div>
                                <div>
                                    <span className="stat-val" style={{color: 'var(--accent-vestiaire)'}}>{stats.uploadedVestiaire}</span>
                                    <span>/</span>
                                    <span className="stat-val">{stats.vestiaire}</span> Ve
                                </div>
                                <div>
                                    <span className="stat-val" style={{color: 'var(--accent-shopify)'}}>{stats.uploadedShopify}</span>
                                    <span>/</span>
                                    <span className="stat-val">{stats.shopify}</span> Sh
                                </div>
                            </div>
                        </div>
                        <div className="header-right">
                            <button className="btn-icon" onClick={refresh} title="Ricarica dati">
                                {refreshing ? '‚ü≥' : '‚Üª'}
                            </button>
                            <button className="btn-icon" onClick={disconnect} title="Disconnetti">‚èª</button>
                        </div>
                    </div>

                    {/* Toolbar */}
                    <div className="toolbar">
                        <div className="search-box">
                            <span className="search-icon">‚åï</span>
                            <input
                                placeholder="Cerca SKU, brand, categoria..."
                                value={search}
                                onChange={e => setSearch(e.target.value)}
                            />
                        </div>

                        <div className="divider-v" />

                        <div className="filter-group">
                            <span className="filter-label">Da caricare su</span>
                            <button
                                className={`filter-btn ${platformFilter === 'Vinted' ? 'active-vinted' : ''}`}
                                onClick={() => togglePlatformFilter('Vinted')}
                            >
                                Vinted <span className="count">{stats.vinted}</span>
                            </button>
                            <button
                                className={`filter-btn ${platformFilter === 'Vestiaire' ? 'active-vestiaire' : ''}`}
                                onClick={() => togglePlatformFilter('Vestiaire')}
                            >
                                Vestiaire <span className="count">{stats.vestiaire}</span>
                            </button>
                            <button
                                className={`filter-btn ${platformFilter === 'Shopify' ? 'active-shopify' : ''}`}
                                onClick={() => togglePlatformFilter('Shopify')}
                            >
                                Shopify <span className="count">{stats.shopify}</span>
                            </button>
                        </div>

                        <div className="status-filters">
                            {['Disponibile', 'Venduto'].map(s => (
                                <button
                                    key={s}
                                    className={`status-chip ${statusFilter === s ? 'active' : ''}`}
                                    onClick={() => setStatusFilter(prev => prev === s ? null : s)}
                                >
                                    {s}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Table */}
                    <div className="table-container">
                        {filtered.length === 0 ? (
                            <div className="empty-state">
                                <div className="icon">üì¶</div>
                                <p>Nessun prodotto trovato con i filtri attuali</p>
                            </div>
                        ) : (
                            <table>
                                <thead>
                                    <tr>
                                        <th>SKU</th>
                                        <th>Foto</th>
                                        <th>Genere</th>
                                        <th>Categoria</th>
                                        <th>Sottocategoria</th>
                                        <th>Brand</th>
                                        <th>Colore</th>
                                        <th>Taglia</th>
                                        <th>Dettagli</th>
                                        <th>Condizione</th>
                                        <th>Prezzo</th>
                                        <th>Target</th>
                                        <th>Status</th>
                                        <th>Titolo Auto</th>
                                        <th>Descrizione Auto</th>
                                        <th style={{textAlign: 'center'}}>Caricato</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filtered.map(record => {
                                        const f = record.fields;
                                        const statusClass = (f['Status'] || '').toLowerCase() === 'disponibile'
                                            ? 'badge-disponibile'
                                            : (f['Status'] || '').toLowerCase() === 'venduto'
                                                ? 'badge-venduto'
                                                : 'badge-default';

                                        const genereClass = (f['Genere'] || '').toLowerCase() === 'uomo'
                                            ? 'badge-uomo'
                                            : (f['Genere'] || '').toLowerCase() === 'donna'
                                                ? 'badge-donna'
                                                : '';

                                        return (
                                            <tr key={record.id}>
                                                <td>
                                                    <span
                                                        className="cell-sku"
                                                        style={{ cursor: 'pointer' }}
                                                        onClick={() => setSelectedRecord(record)}
                                                    >
                                                        {f['SKU'] || '‚Äî'}
                                                    </span>
                                                </td>
                                                <td>
                                                    {(f['Foto Drive'] || f['Drive_Folder_URL']) ? (
                                                        <a className="cell-link" href={f['Foto Drive'] || f['Drive_Folder_URL']} target="_blank" rel="noopener">
                                                            üìÇ
                                                        </a>
                                                    ) : '‚Äî'}
                                                </td>
                                                <td>
                                                    {f['Genere'] ? (
                                                        <span className={`badge badge-genere ${genereClass}`}>
                                                            {f['Genere']}
                                                        </span>
                                                    ) : '‚Äî'}
                                                </td>
                                                <td>{f['Categoria'] || '‚Äî'}</td>
                                                <td>{f['Sottocategoria'] || '‚Äî'}</td>
                                                <td className="cell-brand">{f['Brand'] || '‚Äî'}</td>
                                                <td>{f['Colore'] || '‚Äî'}</td>
                                                <td>{f['Taglia'] || '‚Äî'}</td>
                                                <td>
                                                    <div
                                                        className="cell-truncate"
                                                        title={f['Dettagli'] || ''}
                                                        onClick={() => setSelectedRecord(record)}
                                                    >
                                                        {f['Dettagli'] || '‚Äî'}
                                                    </div>
                                                </td>
                                                <td>{f['Condizione'] || '‚Äî'}</td>
                                                <td className="cell-price">{f['Prezzo_Target'] || '‚Äî'}</td>
                                                <td>{f['Piattaforma'] || '‚Äî'}</td>
                                                <td>
                                                    <span className={`badge ${statusClass}`}>
                                                        {f['Status'] || '‚Äî'}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div
                                                        className="cell-truncate"
                                                        title={f['Titolo_Auto'] || ''}
                                                    >
                                                        {f['Titolo_Auto'] || '‚Äî'}
                                                    </div>
                                                </td>
                                                <td>
                                                    <div
                                                        className="cell-truncate"
                                                        title={f['Descrizione_Auto'] || ''}
                                                        onClick={() => setSelectedRecord(record)}
                                                    >
                                                        {f['Descrizione_Auto'] ? 'üìù Vedi' : '‚Äî'}
                                                    </div>
                                                </td>
                                                <td>
                                                    <div className="check-group">
                                                        {['Vinted', 'Vestiaire', 'Shopify'].map(platform => {
                                                            const cellKey = `${record.id}-${platform}`;
                                                            const isSaving = savingCells.has(cellKey);
                                                            return (
                                                                <div key={platform} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 2 }}>
                                                                    <div className={`platform-check ${isSaving ? 'saving' : ''}`}>
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={!!f[platform]}
                                                                            onChange={e => handleCheckChange(record.id, platform, e.target.checked)}
                                                                            disabled={isSaving}
                                                                        />
                                                                        <div className={`checkmark check-${platform.toLowerCase()}`} />
                                                                    </div>
                                                                    <span className="check-label">{platform.substring(0, 2).toUpperCase()}</span>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        )}
                    </div>

                    {/* Detail Modal */}
                    {selectedRecord && (
                        <DetailModal record={selectedRecord} onClose={() => setSelectedRecord(null)} />
                    )}

                    {/* Toast */}
                    {toast && (
                        <Toast
                            key={toast.key}
                            message={toast.message}
                            type={toast.type}
                            onDone={() => setToast(null)}
                        />
                    )}
                </div>
            );
        }

        // ‚îÄ‚îÄ‚îÄ App Root ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function App() {
            const [state, setState] = useState('setup'); // setup | loading | ready
            const [client, setClient] = useState(null);
            const [records, setRecords] = useState([]);

            // Auto-connect if credentials saved
            useEffect(() => {
                const token = localStorage.getItem('dt_token');
                const baseId = localStorage.getItem('dt_baseId');
                const tableName = localStorage.getItem('dt_tableName');

                if (token && baseId && tableName) {
                    setState('loading');
                    const c = new AirtableClient(token, baseId, tableName);
                    setClient(c);
                    c.fetchAll()
                        .then(recs => { setRecords(recs); setState('ready'); })
                        .catch(() => setState('setup'));
                }
            }, []);

            const handleConnect = (newClient, newRecords) => {
                setClient(newClient);
                setRecords(newRecords);
                setState('ready');
            };

            if (state === 'setup') {
                return <SetupScreen onConnect={handleConnect} />;
            }

            if (state === 'loading') {
                return (
                    <div className="loading-screen">
                        <div className="spinner" />
                        <div className="loading-text">Caricamento inventario...</div>
                    </div>
                );
            }

            return <Dashboard client={client} initialRecords={records} />;
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
